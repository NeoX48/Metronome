# 节拍器应用架构设计

本文档详细描述了节拍器应用的架构设计、模块间依赖关系和数据流。

## 架构概述

节拍器应用采用模块化的分层架构设计，遵循关注点分离原则，将不同功能划分为独立模块。整体架构分为以下几个主要层次：

1. **核心层（core）**：包含应用的核心功能逻辑
2. **音频层（audio）**：负责音频处理和调度
3. **UI层（ui）**：处理用户界面和交互
4. **训练模式层（training）**：实现训练相关功能
5. **工具层（utils）**：提供通用工具函数和服务

## 模块依赖关系

以下是各模块间的依赖关系图（从左到右表示依赖方向）：

```
main.js
  ├── core/metronome.js
  │     ├── audio/scheduler.js
  │     │     └── utils/state.js
  │     ├── audio/soundBuffers.js
  │     │     └── utils/config.js
  │     ├── utils/state.js
  │     └── utils/config.js
  ├── ui/controls.js
  │     ├── utils/helpers.js
  │     │     └── utils/config.js
  │     ├── utils/state.js
  │     └── core/metronome.js
  ├── training/trainingCore.js
  │     ├── utils/state.js
  │     └── core/metronome.js
  ├── training/trainingUI.js
  │     ├── utils/helpers.js
  │     │     └── utils/config.js
  │     ├── utils/state.js
  │     └── training/trainingCore.js
  └── utils/keyboard.js
        ├── utils/config.js
        └── core/metronome.js
```

## 模块职责划分

### 1. 核心层（core/）

#### metronome.js
- **职责**：提供节拍器的核心控制逻辑
- **主要功能**：
  - 初始化节拍器
  - 控制播放/停止
  - 设置BPM、拍号和音量
  - 协调音频模块和状态管理

### 2. 音频层（audio/）

#### scheduler.js
- **职责**：精确调度音频事件
- **主要功能**：
  - 使用Web Audio API的精确计时
  - 管理节拍事件调度
  - 处理播放、暂停、恢复和停止操作

#### soundBuffers.js
- **职责**：管理音频缓冲区和音效播放
- **主要功能**：
  - 生成或加载音效
  - 管理音频缓冲区
  - 处理音效播放

### 3. UI层（ui/）

#### controls.js
- **职责**：管理用户界面元素和交互
- **主要功能**：
  - 初始化UI元素
  - 绑定事件监听器
  - 更新UI显示
  - 处理用户输入

### 4. 训练模式层（training/）

#### trainingCore.js
- **职责**：处理训练会话的核心逻辑
- **主要功能**：
  - 管理训练会话的生命周期
  - 处理段落切换和重复
  - 协调节拍器和训练状态

#### trainingUI.js
- **职责**：管理训练模式的用户界面
- **主要功能**：
  - 初始化训练模式UI
  - 处理段落配置界面
  - 更新训练状态显示

### 5. 工具层（utils/）

#### config.js
- **职责**：管理应用配置
- **主要功能**：
  - 提供默认配置
  - 管理配置更新
  - 提供配置访问接口

#### state.js
- **职责**：管理应用状态
- **主要功能**：
  - 提供状态存储
  - 处理状态更新
  - 实现状态订阅机制

#### helpers.js
- **职责**：提供通用辅助函数
- **主要功能**：
  - DOM操作辅助函数
  - 事件处理辅助函数
  - 工具函数（防抖、节流等）
  - 数据验证和格式化函数

#### keyboard.js
- **职责**：管理键盘快捷键
- **主要功能**：
  - 处理键盘事件
  - 执行快捷键操作
  - 提供键盘控制开关

## 数据流设计

### 状态管理

应用使用中央状态管理机制，主要由`utils/state.js`模块负责。状态更新遵循单向数据流：

1. **状态更新触发**：
   - 用户界面交互（点击按钮、拖动滑块等）
   - 程序内部事件（训练会话开始、段落变更等）
   - 键盘快捷键操作

2. **状态更新流程**：
   - 通过`updateState()`函数更新状态
   - 状态变更通知所有订阅者
   - 订阅者（如UI组件）根据状态更新视图

### 事件系统

应用使用自定义事件进行模块间通信，避免直接依赖，提高模块解耦度：

1. **节拍事件**：`metronome:beat` - 当节拍器触发一个节拍时
2. **训练事件**：
   - `training:start` - 开始训练
   - `training:stop` - 停止训练
   - `training:segmentChange` - 训练段落变更
   - `training:complete` - 训练完成
3. **应用事件**：`app:initialized` - 应用初始化完成

事件系统与状态管理相结合，形成完整的数据流闭环。

## 初始化流程

应用初始化流程如下：

1. **main.js**加载所有模块并启动初始化
2. 初始化核心节拍器模块(`core/metronome.js`)
3. 初始化UI控制器(`ui/controls.js`)
4. 初始化训练模式核心(`training/trainingCore.js`)
5. 初始化训练模式UI(`training/trainingUI.js`)
6. 初始化键盘控制器(`utils/keyboard.js`)
7. 注册全局错误处理
8. 触发`app:initialized`事件

## 错误处理架构

应用采用多层错误处理策略：

1. **模块级别错误处理**：
   - 每个公共API函数都有适当的错误处理
   - 参数验证和边界检查
   - 异常捕获并抛出标准化错误

2. **全局错误处理**：
   - 捕获未处理的JavaScript错误
   - 捕获未处理的Promise拒绝
   - 显示用户友好的错误消息

3. **错误上报机制**：
   - 记录详细的错误信息到控制台
   - 可扩展为远程错误上报

## 性能优化策略

1. **UI交互优化**：
   - 使用防抖和节流函数减少不必要的更新
   - 批量DOM操作
   - 条件渲染

2. **音频处理优化**：
   - 使用Web Audio API的AudioContext进行精确计时
   - 预加载和缓存音频资源
   - 高效的音频调度算法

3. **资源管理**：
   - 懒加载非关键模块（可扩展）
   - 正确释放不再使用的资源
   - 内存泄漏防护

## 扩展性设计

应用架构设计考虑了良好的扩展性：

1. **模块接口标准化**：
   - 清晰的API设计
   - 一致的接口约定
   - 完整的文档

2. **事件驱动通信**：
   - 模块间通过事件通信，减少直接依赖
   - 便于添加新功能而不影响现有代码

3. **可插拔架构**：
   - 新功能可以作为独立模块添加
   - 可配置的功能开关

## 安全考量

1. **输入验证**：
   - 所有用户输入都经过验证
   - 防止无效数据导致应用异常

2. **错误处理**：
   - 不会向用户暴露敏感的错误信息
   - 防止错误信息泄露系统细节

3. **资源限制**：
   - 对用户可配置的参数设置合理范围
   - 防止资源滥用（如无限循环）

## 测试策略

1. **单元测试**：
   - 为每个模块编写独立的单元测试
   - 测试核心功能和边界条件

2. **集成测试**：
   - 测试模块间的交互
   - 验证数据流的正确性

3. **端到端测试**：
   - 测试完整的用户场景
   - 验证UI交互和功能完整性

## 浏览器兼容性

应用架构考虑了浏览器兼容性：

1. **现代API使用**：
   - Web Audio API用于音频处理
   - ES Modules用于模块化
   - 适当的polyfill支持（可扩展）

2. **渐进增强**：
   - 核心功能在所有现代浏览器中可用
   - 高级功能在支持的浏览器中提供增强体验

## 部署与构建

应用采用无构建依赖的设计，使用原生ES Modules：

1. **开发环境**：
   - 使用简单的HTTP服务器（如http-server）
   - 支持热重载（可配置）

2. **生产环境**：
   - 可选择使用打包工具（如Rollup、Webpack）
   - 优化资源加载和缓存

## 未来扩展方向

1. **功能扩展**：
   - 更多音效选项
   - 高级训练模式
   - 可视化节拍器
   - 数据持久化（保存训练计划）

2. **架构增强**：
   - 状态管理优化
   - 组件化重构
   - 支持主题切换
   - 国际化支持

3. **性能提升**：
   - 优化音频调度算法
   - 使用Web Workers处理复杂计算
   - 资源预加载策略优化