<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç®€å•èŠ‚æ‹å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        
        /* å…¨å±å€’æ•°æ ·å¼ */
        .countdown-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            font-family: Arial, sans-serif;
            display: none;
        }
        
        .countdown-number {
            font-size: 20vw;
            color: white;
            font-weight: bold;
            text-align: center;
            animation: pulse 0.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
        
        /* è®­ç»ƒæ§åˆ¶åŒ…è£…å™¨æ ·å¼ */
        .training-controls-wrapper {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 20px 0;
            justify-content: center;
        }
        
        .countdown-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .countdown-control select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background-color: white;
        }
        
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #334f53;
            margin: 0;
            position: relative;
            padding: 20px 0;
        }
        
        /* åŸºç¡€è§¦æ‘¸å‹å¥½è®¾ç½® */
        * {
            touch-action: manipulation; /* é˜²æ­¢åŒå‡»ç¼©æ”¾ */
            -webkit-tap-highlight-color: transparent; /* ç§»é™¤ç‚¹å‡»é«˜äº® */
        }
        
        .container {
            background-color: white;
            border-radius: clamp(8px, 2vw, 12px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            padding: clamp(20px, 6vw, 40px);
            text-align: center;
            max-width: 500px;
            width: 90%;
            margin: 20px auto;
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        
        p {
            color: #666;
            font-size: 16px;
            margin-bottom: 20px;
        }
        
        .bpm-display {
            margin: 20px 0;
            padding: clamp(20px, 5vw, 30px);
            background-color: #f9f9f9;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .denominator-icon {
            font-size: clamp(36px, 10vw, 48px);
            color: #3498db;
            margin-right: 10px;
            font-weight: bold;
        }
        
        #bpm-value {
            font-size: clamp(48px, 15vw, 64px);
            font-weight: bold;
            color: #3498db;
            font-family: 'Courier New', monospace;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .bpm-label {
            font-size: clamp(18px, 5vw, 24px);
            color: #666;
            margin-left: 10px;
        }
        
        .controls {
            margin-top: 20px;
        }
        
        .control-group {
            margin-bottom: clamp(20px, 5vw, 25px);
        }
        
        label {
            display: block;
            margin-bottom: 10px;
            color: #555;
            font-weight: bold;
        }
        
        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .slider-with-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }
        
        .bpm-buttons-container {
            display: flex;
            justify-content: center;
            gap: clamp(80px, 20vw, 150px);
            margin-bottom: 5px;
        }
        
        .bpm-controls-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: clamp(10px, 3vw, 15px);
            margin-bottom: 10px;
        }
        
        .bpm-controls-row label {
            margin: 0;
            font-weight: bold;
        }
        
        button.bpm-control-btn {
            min-width: 40px;
            min-height: 40px;
            width: clamp(30px, 6vw, 40px) !important;
            height: clamp(30px, 6vw, 40px) !important;
            border: none;
            border-radius: 50%;
            background-color: #3498db;
            color: white;
            font-size: clamp(16px, 3vw, 18px) !important;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            margin: 0;
            line-height: 1;
            transition: background-color 0.3s;
        }
        
        .bpm-control-btn:hover {
            background-color: #2980b9;
        }
        
        .bpm-control-btn:active {
            background-color: #1f6dad;
            transform: scale(0.95);
        }
        
        .slider-with-controls input[type="range"] {
            width: 100%;
            height: 6px;
        }
        
        .volume-value {
            background-color: #3498db;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: bold;
            min-width: 30px;
            text-align: center;
            margin: 0 5px;
        }
        
        .volume-unit {
            font-size: 0.9em;
            color: #555;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
            border: none;
        }
        
        .button-group {
            display: flex;
            justify-content: center;
            gap: clamp(10px, 4vw, 20px);
            margin-top: 30px;
            flex-wrap: wrap;
        }
        
        #beat-numerator, #beat-denominator {
            width: 60px;
            padding: 5px;
            margin: 0 5px;
            border: 2px solid #4a90e2;
            border-radius: 4px;
            background-color: white;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }
        
        #beat-numerator:focus, #beat-denominator:focus {
            border-color: #2196F3;
        }
        
        .beat-indicator {
            margin-top: 20px;
            text-align: center;
        }
        
        .indicator-dots {
            display: flex;
            justify-content: center;
            gap: clamp(8px, 2vw, 10px);
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .beat-dot {
            width: clamp(16px, 4vw, 20px);
            height: clamp(16px, 4vw, 20px);
            border-radius: 50%;
            background-color: #ccc;
            transition: all 0.2s ease;
            border: 2px solid #666;
        }
        
        .beat-dot.active {
            background-color: #4a90e2;
            transform: scale(1.2);
        }
        
        .beat-dot.first {
            border-color: #2196F3;
            border-width: 2px;
        }
        
        button {
            padding: clamp(20px, 8vw, 30px);
            min-width: 80px;
            min-height: 80px;
            width: clamp(80px, 20vw, 100px);
            height: clamp(80px, 20vw, 100px);
            font-size: clamp(16px, 4vw, 18px);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s, transform 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
        }
        
        #toggle-btn.start {
            background-color: #27ae60;
            color: white;
        }
        
        #tap-btn {
            background-color: #9b59b6;
            color: white;
            margin: 0 clamp(5px, 2vw, 10px);
            min-width: 90px;
            min-height: 90px;
            width: clamp(90px, 25vw, 120px);
            height: clamp(90px, 25vw, 120px);
            padding: 15px; /* å¢åŠ è§¦æ‘¸åŒºåŸŸ */
        }
        
        #tap-btn:hover {
            background-color: #8e44ad;
        }
        
        #tap-btn:active {
            background-color: #7d3c98;
            transform: scale(0.95);
            transition: all 0.1s;
        }
        
        #toggle-btn.start:hover {
            background-color: #229954;
        }
        
        #toggle-btn.stop {
            background-color: #e74c3c;
            color: white;
        }
        
        #toggle-btn.stop:hover {
            background-color: #c0392b;
        }
        
        #reset-btn {
            background-color: #9b59b6;
            color: white;
            margin-left: 20px;
        }
        
        #reset-btn:hover {
            background-color: #8e44ad;
        }

        #training-btn {
            background-color: #e67e22;
            color: white;
            margin-left: 10px;
        }

        #training-btn:hover {
            background-color: #d35400;
        }

        /* æ¨¡æ€çª—å£æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 600px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 15px;
            border-bottom: 2px solid #3498db;
            margin-bottom: 20px;
        }

        .close-modal {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #666;
        }

        .close-modal:hover {
            color: #000;
        }

        .training-mode {
            margin-bottom: 20px;
        }

        .training-mode h3 {
            color: #3498db;
            margin-bottom: 15px;
        }

        .training-control-group {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .training-control-group label {
            flex: 0 0 180px;
            margin-bottom: 0;
        }

        .training-control-group input {
            flex: 1;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 4px;
        }

        .training-control-group input:focus {
            border-color: #3498db;
            outline: none;
        }

        .toggle-training {
            padding: 12px 24px;
            margin: 10px 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .toggle-training.start {
            background-color: #27ae60;
            color: white;
        }

        .toggle-training.start:hover {
            background-color: #229954;
        }

        .toggle-training.stop {
            background-color: #e74c3c;
            color: white;
        }

        .toggle-training:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .stop-training:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .training-status {
            margin-top: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }

        .training-status p {
            margin: 5px 0;
        }

        .training-status #training-status-text {
            font-weight: bold;
            color: #27ae60;
        }

        .search-container {
            position: relative;
            margin-top: 10px;
        }
        
        #component-search {
            width: 100%;
            padding: 8px 30px 8px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .search-icon {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #888;
        }
        
        .search-results-count {
            font-size: 12px;
            color: #666;
            margin: 5px 0 10px 0;
            text-align: right;
        }
        
        .no-results {
            text-align: center;
            padding: 20px;
            color: #888;
            font-style: italic;
        }
        
        mark {
            background-color: #ffeb3b;
            color: #000;
            padding: 0 2px;
            border-radius: 2px;
        }

        #inspector-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        /* ç»„ä»¶æŸ¥çœ‹å™¨æ ·å¼ */
        .component-inspector {
            position: fixed;
            top: 0;
            right: -450px;
            width: 450px;
            height: 100vh;
            background-color: #f5f5f5;
            box-shadow: -2px 0 10px rgba(0,0,0,0.15);
            z-index: 999;
            overflow-y: auto;
            transition: right 0.3s ease;
            padding: 20px;
        }

        .component-inspector.active {
            right: 0;
        }

        .inspector-header {
            border-bottom: 2px solid #3498db;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .inspector-header h2 {
            color: #333;
            margin: 0;
        }

        /* æœç´¢å®¹å™¨æ ·å¼ */
        .search-container {
            position: relative;
            margin-bottom: 20px;
        }

        #component-search {
            width: 100%;
            padding: 8px 35px 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        #component-search:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .search-icon {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
            pointer-events: none;
        }

        /* è¿‡æ»¤å™¨æ§ä»¶æ ·å¼ */
        .filter-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .filter-controls select {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .filter-controls select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        /* ç»„ä»¶ç»„æ ·å¼ */
        .component-group {
            margin-bottom: 20px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e0e0e0;
            background: white;
        }

        .group-header {
            background-color: #f8f9fa;
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e0e0e0;
            transition: background-color 0.2s ease;
        }

        .group-header:hover {
            background-color: #e9ecef;
        }

        .group-header h3 {
            color: #3498db;
            margin: 0;
            font-size: 16px;
            border-left: 4px solid #3498db;
            padding-left: 10px;
            display: flex;
            align-items: center;
        }

        .group-header h3::before {
            content: "ğŸ“¦";
            margin-right: 8px;
            font-size: 14px;
        }

        .toggle-icon {
            font-size: 12px;
            color: #666;
            transition: transform 0.2s ease;
        }

        .group-content {
            padding: 10px 15px;
        }

        /* ç»„ä»¶é¡¹æ ·å¼ */
        .component-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
            border: 1px solid transparent;
            animation: fadeIn 0.3s ease-out;
        }

        .component-item:hover {
            background-color: #f9f9f9;
            cursor: pointer;
            border-color: #3498db;
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .component-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .component-title {
            font-weight: bold;
            color: #2c3e50;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
            font-size: 15px;
            margin: 0;
            flex: 1;
        }

        /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .component-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #999;
            margin-left: 10px;
            flex-shrink: 0;
        }

        .component-indicator[data-status="visible"] {
            background-color: #27ae60;
            animation: pulse 2s infinite;
        }

        .component-indicator[data-status="hidden"] {
            background-color: #e74c3c;
        }

        .component-info {
            font-size: 14px;
            margin-bottom: 15px;
        }

        .info-row {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
        }

        .info-label {
            flex: 0 0 120px;
            color: #7f8c8d;
            font-weight: 500;
            font-size: 13px;
        }

        .info-value {
            flex: 1;
            color: #2c3e50;
            word-break: break-all;
            font-family: 'Courier New', monospace;
            background-color: #f8f9fa;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 13px;
            transition: background-color 0.3s ease;
        }

        /* æ›´æ–°é«˜äº®æ•ˆæœ */
        .info-value.updated {
            background-color: rgba(52, 152, 219, 0.3);
            animation: highlight 1s ease-out;
        }

        /* æ—¶é—´æˆ³è¡Œæ ·å¼ */
        .timestamp-row {
            opacity: 0.7;
            font-size: 12px;
        }

        /* æ“ä½œæŒ‰é’®å®¹å™¨ */
        .component-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }

        /* æ“ä½œæŒ‰é’®æ ·å¼ */
        .component-actions button {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .refresh-btn {
            background-color: #9b59b6;
            color: white;
        }

        .refresh-btn:hover {
            background-color: #8e44ad;
            transform: translateY(-1px);
        }

        .highlight-btn {
            background-color: #27ae60;
            color: white;
        }

        .highlight-btn:hover {
            background-color: #229954;
            transform: translateY(-1px);
        }

        .inspect-btn {
            background-color: #e67e22;
            color: white;
        }

        .inspect-btn:hover {
            background-color: #d35400;
            transform: translateY(-1px);
        }

        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes highlight {
            0% { background-color: rgba(52, 152, 219, 0.3); }
            100% { background-color: #f8f9fa; }
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }

        .highlight-btn, .inspect-btn {
            flex: 1;
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .highlight-btn {
            background-color: #3498db;
            color: white;
        }

        .highlight-btn:hover {
            background-color: #2980b9;
            transform: translateY(-1px);
        }

        .inspect-btn {
            background-color: #ecf0f1;
            color: #2c3e50;
            border: 1px solid #ddd;
        }

        .inspect-btn:hover {
            background-color: #e74c3c;
            color: white;
            transform: translateY(-1px);
        }

        .refresh-btn {
            margin-top: 10px;
            padding: 8px 16px;
            background-color: #2ecc71;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
            transition: all 0.2s ease;
        }

        .refresh-btn:hover {
            background-color: #27ae60;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(46, 204, 113, 0.3);
        }

        /* é«˜äº®å…ƒç´ æ ·å¼ */
        .highlighted-element {
            outline: 3px solid #4CAF50;
            animation: pulse 1s infinite;
            position: relative;
            z-index: 998;
        }

        @keyframes pulse {
            0% { 
                outline-color: #4CAF50;
                outline-width: 3px;
            }
            50% { 
                outline-color: #2196F3;
                outline-width: 4px;
            }
            100% { 
                outline-color: #4CAF50;
                outline-width: 3px;
            }
        }

        /* ç»Ÿè®¡ä¿¡æ¯åŒºåŸŸ */
        .stats-section {
            background-color: #e3f2fd;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }

        .stats-header {
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .stats-content {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .stats-content span {
            background-color: white;
            padding: 3px 8px;
            border-radius: 3px;
            font-weight: 500;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        /* åŠ è½½å’Œæ— ç»“æœæç¤º */
        .loading-message {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            font-style: italic;
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: #e74c3c;
            font-style: italic;
            background-color: #fdedec;
            border: 1px solid #fadbd8;
            border-radius: 8px;
        }

        /* åˆ‡æ¢æŒ‰é’® */
        #inspector-toggle {
            position: fixed;
            right: 20px;
            top: 20px;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background-color: #3498db;
            color: white;
            border: none;
            font-size: 20px;
            cursor: pointer;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(52, 152, 219, 0.4);
        }

        #inspector-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.6);
        }

        #inspector-toggle.active {
            background-color: #e74c3c;
            transform: rotate(45deg);
        }

        /* æœç´¢é«˜äº®æ ·å¼ */
        mark {
            background-color: #ff9800;
            color: white;
            padding: 1px 4px;
            border-radius: 2px;
            font-weight: bold;
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        .component-inspector::-webkit-scrollbar {
            width: 6px;
        }

        .component-inspector::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .component-inspector::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 3px;
        }

        .component-inspector::-webkit-scrollbar-thumb:hover {
            background: #999;
        }
    </style>
</head>
<body>
        <!-- å…¨å±å€’æ•°è¦†ç›–å±‚ -->
        <div id="countdown-overlay" class="countdown-overlay">
            <div id="countdown-number" class="countdown-number">3</div>
        </div>
    <div class="container">
        <h1>ç®€å•èŠ‚æ‹å™¨</h1>
        <p>è¿™æ˜¯ä¸€ä¸ªç®€å•çš„èŠ‚æ‹å™¨åº”ç”¨ï¼Œæˆ‘ä»¬å°†é€æ­¥å®Œå–„å®ƒçš„åŠŸèƒ½ã€‚</p>
        <div class="beat-indicator">
            <div class="indicator-dots" id="indicator-dots"></div>
        </div>
        <div class="bpm-display">
            <span id="denominator-icon" class="denominator-icon">ğ…˜ğ…¥</span>
            <span id="bpm-value">120</span>
            <span class="bpm-label">BPM</span>
        </div>
        <div class="controls">
            <div class="control-group">
                <div class="bpm-controls-row">
                    <button id="bpm-decrease" class="bpm-control-btn decrease-btn">-</button>
                    <label for="bpm-slider">è°ƒæ•´é€Ÿåº¦ (BPM)</label>
                    <button id="bpm-increase" class="bpm-control-btn increase-btn">+</button>
                </div>
                <div class="slider-with-controls">
                    <input type="range" id="bpm-slider" min="20" max="300" value="120" step="1">
                </div>
            </div>
            <div class="control-group">
                <label for="tone-selector">éŸ³è‰²é€‰æ‹©:</label>
                <select id="tone-selector">
                    <option value="standard">æ ‡å‡†1</option>
                    <option value="soft">æ ‡å‡†2</option>
                    <option value="electronic">ç”µå­1</option>
                </select>
            </div>
            <div class="control-group">
                <label for="volume-slider">è°ƒæ•´éŸ³é‡:</label>
                <span id="volume-value" class="volume-value">50</span>
                <span class="volume-unit">%</span>
                <input type="range" id="volume-slider" min="0" max="100" value="50" step="1">
            </div>
            <div class="control-group">
                <label>èŠ‚æ‹æ¨¡å¼:</label>
                <select id="beat-numerator"></select>
                <span>/</span>
                <select id="beat-denominator">
                    <option value="1">1 ğ…</option>
                    <option value="2">2 ğ…—ğ…¥</option>
                    <option value="4" selected>4 ğ…˜ğ…¥</option>
                    <option value="8">8 ğ…˜ğ…¥ğ…®</option>
                    <option value="16">16 ğ…˜ğ…¥ğ…¯</option>
                    <option value="32">32 ğ…˜ğ…¥ğ…°</option>
                </select>
                <span>ç»†åˆ†:</span>
                <select id="subdivision">
                    <option value="1" selected>1Ã— ğ…˜ğ…¥</option>
                    <option value="2">2Ã— ğ…˜ğ…¥ğ…® ğ…˜ğ…¥ğ…®</option>
                    <option value="3">3Ã— ğ…˜ğ…¥â©¦</option>
                    <option value="4">4Ã— ğ…˜ğ…¥ğ…¯ ğ…˜ğ…¥ğ…¯ ğ…˜ğ…¥ğ…¯ ğ…˜ğ…¥ğ…¯</option>
                    <option value="5">5Ã— ğ…˜ğ…¥â©§</option>
                    <option value="6">6Ã— ğ…˜ğ…¥ğ…®â©¦ ğ…˜ğ…¥ğ…®â©¦</option>
                    <option value="7">7Ã— ğ…˜ğ…¥â©¨</option>
                    <option value="8">8Ã— ğ…˜ğ…¥ğ…° ğ…˜ğ…¥ğ…° ğ…˜ğ…¥ğ…° ğ…˜ğ…¥ğ…° ğ…˜ğ…¥ğ…° ğ…˜ğ…¥ğ…° ğ…˜ğ…¥ğ…° ğ…˜ğ…¥ğ…°</option>
                    <option value="dotted">é™„ç‚¹ ğ…˜ğ…¥. ğ…˜ğ…¥ğ…®</option>
                    <option value="ddotted">åŒé™„ç‚¹ ğ…˜ğ…¥.. ğ…˜ğ…¥ğ…¯</option>
                    <option value="eighth_dotted">é™„ç‚¹å…«åˆ† ğ…˜ğ…¥ğ…®. ğ…˜ğ…¥ğ…¯</option>
                    <option value="swing">æ‘‡æ‘† ğ…˜ğ…¥ğ…® ğ…˜ğ…¥ğ…®</option>
                    <option value="triplet_duplet">ä¸‰è¿äºŒ ğ…˜ğ…¥â©¦ ğ…˜ğ…¥â©¦ ğ…˜ğ…¥</option>
                    <option value="rest">ä¼‘æ­¢ç¬¦ ğ„¼ ğ…˜ğ…¥</option>
                </select>
            </div>
            <div class="button-group">
                <button id="tap-btn" class="tap">TAP</button>
                <button id="toggle-btn" class="start">å¼€å§‹</button>
                <button id="reset-btn" class="reset">å¤ä½</button>
                <button id="training-btn" class="training">è®­ç»ƒ</button>
            </div>
        </div>
    </div>

    <!-- è®­ç»ƒæ¨¡å¼æ¨¡æ€çª—å£ -->
    <div id="training-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>è®­ç»ƒæ¨¡å¼</h2>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="training-mode-tabs">
                    <div class="tab-buttons">
                        <button class="tab-btn active" data-tab="progressive">å˜é€Ÿæ¨¡å¼</button>
                        <button class="tab-btn" data-tab="segmented">åˆ†æ®µè®­ç»ƒ</button>
                        <button class="tab-btn" data-tab="random">éšæœºå˜é€Ÿæ¨¡å¼</button>
                        <button class="tab-btn" data-tab="rhythm">èŠ‚å¥æ§åˆ¶</button>
                    </div>
                    
                    <!-- å˜é€Ÿæ¨¡å¼å†…å®¹ -->
                    <div class="tab-content active" id="progressive-tab">
                        <h3>å˜é€Ÿæ¨¡å¼</h3>
                        <div class="training-control-group">
                            <label>åˆå§‹é€Ÿåº¦ (BPM):</label>
                            <input type="number" id="initial-bpm" min="20" max="300" value="60">
                        </div>
                        <div class="training-control-group">
                            <label>ç›®æ ‡é€Ÿåº¦ (BPM):</label>
                            <input type="number" id="target-bpm" min="20" max="300" value="120">
                        </div>
                        <div class="training-control-group">
                            <label>æ¯å¤šå°‘å°èŠ‚å˜åŒ–ä¸€æ¬¡:</label>
                            <input type="number" id="bars-per-change" min="1" max="16" value="4">
                        </div>
                        <div class="training-control-group">
                            <label>æ¯æ¬¡å˜åŒ–é‡ (BPM):</label>
                            <input type="number" id="bpm-change-step" min="1" max="10" value="3">
                        </div>
                    </div>
                    
                    <!-- éšæœºå˜é€Ÿæ¨¡å¼å†…å®¹ -->
                    <div class="tab-content" id="random-tab">
                        <h3>éšæœºå˜é€Ÿæ¨¡å¼</h3>
                        <div class="training-control-group">
                            <label>åŸºç¡€é€Ÿåº¦ (BPM):</label>
                            <input type="number" id="base-bpm" min="20" max="300" value="120">
                        </div>
                        <div class="training-control-group">
                            <label>éšæœºå˜åŒ–èŒƒå›´ (5%-10%):</label>
                            <select id="random-range">
                                <option value="5">Â±5%</option>
                                <option value="7">Â±7%</option>
                                <option value="10" selected>Â±10%</option>
                            </select>
                        </div>
                        <div class="training-control-group">
                            <label>æ¯å¤šå°‘å°èŠ‚éšæœºå˜åŒ–ä¸€æ¬¡:</label>
                            <input type="number" id="random-change-interval" min="1" max="16" value="4">
                        </div>
                    </div>

                    <!-- èŠ‚å¥æ§åˆ¶å†…å®¹ -->
                    <div class="tab-content" id="rhythm-tab">
                        <h3>èŠ‚å¥æ§åˆ¶</h3>
                        <div class="training-control-group">
                            <label>åŸºç¡€é€Ÿåº¦ (BPM):</label>
                            <input type="number" id="rhythm-base-bpm" min="20" max="300" value="120">
                        </div>
                        <div class="training-control-group">
                            <label>å°èŠ‚é™éŸ³æ¦‚ç‡:</label>
                            <select id="mute-probability">
                                <option value="5">5%</option>
                                <option value="10">10%</option>
                                <option value="15">15%</option>
                                <option value="20">20%</option>
                                <option value="25">25%</option>
                                <option value="30">30%</option>
                                <option value="35">35%</option>
                                <option value="40">40%</option>
                                <option value="45">45%</option>
                                <option value="50">50%</option>
                                <option value="55">55%</option>
                                <option value="60">60%</option>
                                <option value="65">65%</option>
                                <option value="70">70%</option>
                                <option value="75">75%</option>
                                <option value="80">80%</option>
                                <option value="85">85%</option>
                                <option value="90">90%</option>
                                <option value="95">95%</option>
                            </select>
                        </div>

                    </div>

                    <!-- åˆ†æ®µè®­ç»ƒå†…å®¹ -->
                    <div class="tab-content" id="segmented-tab">
                        <h3>åˆ†æ®µè®­ç»ƒ</h3>
                        <div class="training-control-group">
                            <label>åˆ†æ®µæ•°é‡:</label>
                            <input type="number" id="segments-count" min="2" max="8" value="2">
                        </div>
                        <div class="training-control-group">
                            <label><input type="checkbox" id="loop-segments" checked> å¾ªç¯æ’­æ”¾</label>
                        </div>
                        <div id="segments-container" class="segments-container">
                    <!-- åˆ†æ®µè®¾ç½®å°†åŠ¨æ€ç”Ÿæˆ -->
                </div>
                    </div>
                    
                    <div class="training-controls-wrapper">
                        <div class="countdown-control">
                            <label for="countdown-beats">é¢„å¤‡æ‹: </label>
                            <select id="countdown-beats">
                                <option value="0">0æ‹ï¼ˆç›´æ¥å¼€å§‹ï¼‰</option>
                                <option value="1">1æ‹</option>
                                <option value="2">2æ‹</option>
                                <option value="3">3æ‹</option>
                                <option value="4">4æ‹</option>
                                <option value="5">5æ‹</option>
                                <option value="6">6æ‹</option>
                                <option value="7">7æ‹</option>
                                <option value="8">8æ‹</option>
                            </select>
                        </div>
                        <button id="toggle-training-btn" class="toggle-training start">å¼€å§‹è®­ç»ƒ</button>
                    </div>
                    <div class="training-status">
                        <p id="training-status-text">å°±ç»ª</p>
                        <p id="current-training-bpm">å½“å‰BPM: <span id="training-bpm-value">60</span></p>
                        <p id="bars-count">å·²å®Œæˆ: <span id="bars-completed">0</span> / <span id="bars-until-change">4</span> å°èŠ‚</p>
                        <p id="segment-info" style="display: none;">å½“å‰åˆ†æ®µ: <span id="current-segment">1</span> / <span id="total-segments">2</span></p>
                    </div>
                </div>
                </div>
            </div>
        </div>
    </div>

    <button id="inspector-toggle">â“˜</button>
    <div class="component-inspector">
        <div class="inspector-header">
            <h2>ç»„ä»¶ä¿¡æ¯æŸ¥çœ‹å™¨</h2>
            <div class="search-container">
                <input type="text" id="component-search" placeholder="æœç´¢ç»„ä»¶...">
                <span class="search-icon">ğŸ”</span>
            </div>
        </div>
        <div id="components-container"></div>
        <button class="refresh-btn" id="refresh-inspector">åˆ·æ–°ä¿¡æ¯</button>
    </div>

    <script>
        // æ·»åŠ æ—¥å¿—å‡½æ•°
        function log(...args) {
            console.log(...args);
        }
        
        // è·å–DOMå…ƒç´ 
        const bpmValueElement = document.getElementById('bpm-value');
        const bpmSliderElement = document.getElementById('bpm-slider');
        const volumeSliderElement = document.getElementById('volume-slider');
        const toggleButton = document.getElementById('toggle-btn');
        const beatNumeratorElement = document.getElementById('beat-numerator');
        const beatDenominatorElement = document.getElementById('beat-denominator');
        const subdivisionElement = document.getElementById('subdivision');
        const indicatorDotsElement = document.getElementById('indicator-dots');
        
        // å®šä¹‰èŠ‚æ‹å™¨çŠ¶æ€å˜é‡
        let isRunning = false;
        let isStopping = false;
        let audioContext = null;
        let mainGainNode = null; // ä¸»éŸ³é‡èŠ‚ç‚¹
        let currentVolume = 0.5;
        let currentTone = 'standard';
        const toneSelectorElement = document.getElementById('tone-selector');
        let currentBeatPosition = 1;
        let currentNumerator = 4;
        let currentDenominator = 4;
        let currentSubdivision = '1';
        
        // æ›´æ–°BPMæ˜¾ç¤ºå‡½æ•°
        function updateBPMDisplay(bpm) {
            if (bpmValueElement) {
                bpmValueElement.textContent = bpm;
            }
        }

        // éŸ³é¢‘ç¼“å­˜
        const soundBuffers = {}; // å­˜å‚¨ä¸åŒéŸ³è‰²çš„éŸ³é¢‘ç¼“å†²åŒº
        
        // è°ƒåº¦ç›¸å…³å˜é‡
        let nextBeatTime = 0; // ä¸‹ä¸€æ‹çš„è®¡åˆ’æ—¶é—´ç‚¹ï¼ˆç§’ï¼‰
        let schedulerID = null; // è°ƒåº¦å™¨ID
        const SCHEDULE_AHEAD_TIME = 0.1; // é¢„æ’æ—¶é—´çª—å£ï¼ˆç§’ï¼‰
        
        // åˆå§‹åŒ–èŠ‚æ‹åˆ†å­é€‰æ‹©å™¨é€‰é¡¹ï¼ˆ1-16ï¼‰
        for (let i = 1; i <= 16; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = i;
            if (i === 4) {
                option.selected = true;
            }
            beatNumeratorElement.appendChild(option);
        }
        
        // ç”ŸæˆèŠ‚æ‹æŒ‡ç¤ºå™¨
        function generateBeatIndicators() {
            if (!indicatorDotsElement) {
                console.error('èŠ‚æ‹æŒ‡ç¤ºå™¨å®¹å™¨ä¸å­˜åœ¨');
                return;
            }
            
            indicatorDotsElement.innerHTML = '';
            
            for (let i = 1; i <= currentNumerator; i++) {
                const dot = document.createElement('div');
                dot.className = 'beat-dot';
                if (i === 1) {
                    dot.classList.add('first');
                }
                indicatorDotsElement.appendChild(dot);
            }
        }
        
        // æ›´æ–°æ´»åŠ¨èŠ‚æ‹æŒ‡ç¤ºå™¨
        function updateActiveIndicator() {
            const dots = document.querySelectorAll('.beat-dot');
            dots.forEach((dot, index) => {
                dot.classList.remove('active');
                if (index + 1 === currentBeatPosition) {
                    dot.classList.add('active');
                }
            });
        }
        
        generateBeatIndicators();

        // åˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡çš„å‡½æ•°
        function initAudioContext() {
            try {
                const AudioContextConstructor = window.AudioContext || window.webkitAudioContext;
                if (AudioContextConstructor) {
                    const context = new AudioContextConstructor();
                    // åˆ›å»ºä¸»éŸ³é‡èŠ‚ç‚¹
                    const gainNode = context.createGain();
                    gainNode.gain.setValueAtTime(currentVolume, context.currentTime);
                    gainNode.connect(context.destination);
                    
                    // è®¾ç½®å…¨å±€å˜é‡
                    audioContext = context;
                    mainGainNode = gainNode;
                    
                    // åˆå§‹åŒ–éŸ³é¢‘ç¼“å†²åŒº
                    generateSoundBuffers();
                    
                    return context;
                } else {
                    console.error('Web Audio APIä¸æ”¯æŒï¼Œè¯·ä½¿ç”¨ç°ä»£æµè§ˆå™¨');
                    return null;
                }
            } catch (e) {
                console.error('åˆ›å»ºAudioContextæ—¶å‡ºé”™:', e);
                return null;
            }
        }

        // ç”ŸæˆéŸ³é¢‘ç¼“å†²åŒº
        function generateSoundBuffers() {
            if (!audioContext) return;
            
            const sampleRate = audioContext.sampleRate;
            const duration = 0.08; // ç‚¹å‡»éŸ³æ•ˆæŒç»­æ—¶é—´ï¼ˆç§’ï¼‰
            const frameCount = Math.floor(duration * sampleRate);
            
            // ç”Ÿæˆæ ‡å‡†éŸ³è‰²ï¼ˆæ­£å¼¦æ³¢ï¼‰
            const standardBuffer = audioContext.createBuffer(1, frameCount, sampleRate);
            const standardData = standardBuffer.getChannelData(0);
            for (let i = 0; i < frameCount; i++) {
                const time = i / sampleRate;
                // è¡°å‡çš„æ­£å¼¦æ³¢
                standardData[i] = Math.sin(2 * Math.PI * 800 * time) * Math.exp(-5 * time);
            }
            soundBuffers.standard = standardBuffer;
            
            // ç”Ÿæˆå¼ºæ‹æ ‡å‡†éŸ³è‰²ï¼ˆæ›´é«˜é¢‘ç‡ï¼‰
            const standardAccentBuffer = audioContext.createBuffer(1, frameCount, sampleRate);
            const standardAccentData = standardAccentBuffer.getChannelData(0);
            for (let i = 0; i < frameCount; i++) {
                const time = i / sampleRate;
                standardAccentData[i] = Math.sin(2 * Math.PI * 1000 * time) * Math.exp(-5 * time);
            }
            soundBuffers.standardAccent = standardAccentBuffer;
            
            // ç”Ÿæˆç”µå­éŸ³è‰²ï¼ˆæ–¹æ³¢æ¨¡æ‹Ÿï¼‰
            const electronicBuffer = audioContext.createBuffer(1, frameCount, sampleRate);
            const electronicData = electronicBuffer.getChannelData(0);
            for (let i = 0; i < frameCount; i++) {
                const time = i / sampleRate;
                // æ–¹æ³¢è¿‘ä¼¼
                const square = Math.sin(2 * Math.PI * 600 * time) >= 0 ? 1 : -1;
                electronicData[i] = square * Math.exp(-8 * time);
            }
            soundBuffers.electronic = electronicBuffer;
            
            // ç”Ÿæˆç”µå­å¼ºæ‹éŸ³è‰²
            const electronicAccentBuffer = audioContext.createBuffer(1, frameCount, sampleRate);
            const electronicAccentData = electronicAccentBuffer.getChannelData(0);
            for (let i = 0; i < frameCount; i++) {
                const time = i / sampleRate;
                const square = Math.sin(2 * Math.PI * 1200 * time) >= 0 ? 1 : -1;
                electronicAccentData[i] = square * Math.exp(-8 * time);
            }
            soundBuffers.electronicAccent = electronicAccentBuffer;
            
            // ç”ŸæˆæŸ”å’ŒéŸ³è‰²ï¼ˆå¹³æ»‘çš„æ­£å¼¦æ³¢ï¼‰
            const softBuffer = audioContext.createBuffer(1, frameCount, sampleRate);
            const softData = softBuffer.getChannelData(0);
            for (let i = 0; i < frameCount; i++) {
                const time = i / sampleRate;
                // å¹³æ»‘çš„æ­£å¼¦æ³¢ï¼Œæ›´å¿«çš„è¡°å‡
                softData[i] = Math.sin(2 * Math.PI * 600 * time) * Math.exp(-10 * time);
            }
            soundBuffers.soft = softBuffer;
            
            // ç”ŸæˆæŸ”å’Œå¼ºæ‹éŸ³è‰²
            const softAccentBuffer = audioContext.createBuffer(1, frameCount, sampleRate);
            const softAccentData = softAccentBuffer.getChannelData(0);
            for (let i = 0; i < frameCount; i++) {
                const time = i / sampleRate;
                softAccentData[i] = Math.sin(2 * Math.PI * 800 * time) * Math.exp(-10 * time);
            }
            soundBuffers.softAccent = softAccentBuffer;
            
            console.log('éŸ³é¢‘ç¼“å†²åŒºç”Ÿæˆå®Œæˆ');
        }
        
        function ensureAudioContext() {
            if (!audioContext) {
                console.warn('éŸ³é¢‘ä¸Šä¸‹æ–‡æœªåˆå§‹åŒ–');
                return false;
            }
            
            if (!mainGainNode) {
                // å¦‚æœä¸»éŸ³é‡èŠ‚ç‚¹ä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ª
                mainGainNode = audioContext.createGain();
                mainGainNode.gain.setValueAtTime(currentVolume, audioContext.currentTime);
                mainGainNode.connect(audioContext.destination);
                
                // ç¡®ä¿éŸ³é¢‘ç¼“å†²åŒºå·²ç”Ÿæˆ
                if (Object.keys(soundBuffers).length === 0) {
                    generateSoundBuffers();
                }
            }
            
            if (audioContext.state === 'suspended') {
                try {
                    audioContext.resume();
                } catch (e) {
                    console.error('æ¢å¤éŸ³é¢‘ä¸Šä¸‹æ–‡å¤±è´¥:', e);
                    return false;
                }
            }
            
            if (audioContext.state !== 'running') {
                console.warn('éŸ³é¢‘ä¸Šä¸‹æ–‡çŠ¶æ€å¼‚å¸¸:', audioContext.state);
                return false;
            }
            
            return true;
        }

        // åœ¨æŒ‡å®šæ—¶é—´å®‰æ’æ’­æ”¾èŠ‚æ‹
        function scheduleBeatAt(startTime) {
            if (isStopping || !isRunning) {
                console.log('å·²è§¦å‘åœæ­¢ï¼Œæ‹¦æˆªè°ƒåº¦è¯·æ±‚');
                return;
            }

            if (!ensureAudioContext()) {
                console.warn('éŸ³é¢‘ä¸Šä¸‹æ–‡çŠ¶æ€å¼‚å¸¸ï¼Œæ— æ³•è°ƒåº¦');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦éœ€è¦é™éŸ³å½“å‰å°èŠ‚
            const shouldMuteBar = isTrainingMode && trainingModeType === 'rhythm' && trainingConfig.muteCurrentBar;
            
            try {
                if (isStopping || !isRunning) {
                    console.log('æ‰§è¡Œå‰çŠ¶æ€æ£€æŸ¥å¤±è´¥ï¼Œæ‹¦æˆªè°ƒåº¦');
                    return;
                }
                
                const isFirstBeat = currentBeatPosition === 1;
                const currentBPM = parseInt(bpmSliderElement.value);
                
                const beatInterval = (60000 / currentBPM) / 1000;
                
                // æ ¹æ®ç»†åˆ†éŸ³æ¨¡å¼ç”ŸæˆéŸ³ç¬¦åºåˆ—
                const notePattern = generateSubdivisionPattern(currentSubdivision, beatInterval);
                
                // åªæœ‰å½“ä¸éœ€è¦é™éŸ³å½“å‰å°èŠ‚æ—¶æ‰æ’­æ”¾å£°éŸ³
                if (!shouldMuteBar) {
                    playSubdivisionPattern(notePattern, startTime, isFirstBeat, beatInterval);
                    
                    // æ›´æ–°èŠ‚æ‹ä½ç½®æŒ‡ç¤ºå™¨ï¼ˆä½¿ç”¨å½“å‰ä½ç½®ï¼‰
                    updateActiveIndicator();
                } else {
                    // é™éŸ³æ—¶ä»æ›´æ–°è§†è§‰æŒ‡ç¤ºå™¨ï¼Œä½†ä¸æ’­æ”¾å£°éŸ³
                    if (currentBeatPosition === 1) {
                        updateActiveIndicator();
                    }
                }
                
                // æ›´æ–°èŠ‚æ‹ä½ç½®
                currentBeatPosition++;
                
                // è·å–å½“å‰åº”è¯¥ä½¿ç”¨çš„æ¯å°èŠ‚æ‹æ•°
                const activeNumerator = currentNumerator; // ç§»é™¤äº†èŠ‚å¥æ§åˆ¶æ¨¡å¼ä¸‹çš„è‡ªå®šä¹‰æ‹æ•°é…ç½®
                
                // å½“åˆ°è¾¾å°èŠ‚ç»“æŸæ—¶
                if (currentBeatPosition > activeNumerator) {
                    // å°èŠ‚ç»“æŸï¼Œè°ƒç”¨è®­ç»ƒæ¨¡å¼å›è°ƒ
                    if (isTrainingMode) {
                        // å¦‚æœæ˜¯èŠ‚å¥æ§åˆ¶æ¨¡å¼ï¼Œé‡ç½®é™éŸ³æ ‡å¿—
                        if (trainingModeType === 'rhythm') {
                            trainingConfig.muteCurrentBar = false;
                        }
                        onBarComplete();
                    }
                    
                    // é‡ç½®èŠ‚æ‹ä½ç½®åˆ°ä¸‹ä¸€å°èŠ‚çš„ç¬¬ä¸€æ‹
                    currentBeatPosition = 1;
                }
                
            } catch (e) {
                console.error('è°ƒåº¦èŠ‚æ‹å‡ºé”™:', e);
            }
        }
        
        // ä¿æŒå‘åå…¼å®¹çš„playBeatå‡½æ•°ï¼Œç«‹å³æ’­æ”¾ä¸€ä¸ªèŠ‚æ‹
        function playBeat() {
            scheduleBeatAt(audioContext.currentTime);
        }
        
        // æ ¹æ®ç»†åˆ†éŸ³æ¨¡å¼ç”ŸæˆéŸ³ç¬¦æ—¶é—´ç‚¹å’ŒéŸ³é‡æ¨¡å¼
        function generateSubdivisionPattern(subdivision, beatInterval) {
            const pattern = [];
            
            switch(subdivision) {
                case '1': // ä¸€ç­‰åˆ†
                    pattern.push({ time: 0, volume: 1.0, isMain: true });
                    break;
                case '2': // äºŒç­‰åˆ†
                    pattern.push({ time: 0, volume: 1.0, isMain: true });
                    pattern.push({ time: beatInterval / 2, volume: 0.8, isMain: false });
                    break;
                case '3': // ä¸‰è¿éŸ³
                    pattern.push({ time: 0, volume: 1.0, isMain: true });
                    pattern.push({ time: beatInterval / 3, volume: 0.7, isMain: false });
                    pattern.push({ time: beatInterval * 2 / 3, volume: 0.7, isMain: false });
                    break;
                case '4': // å››ç­‰åˆ†
                    pattern.push({ time: 0, volume: 1.0, isMain: true });
                    pattern.push({ time: beatInterval / 4, volume: 0.6, isMain: false });
                    pattern.push({ time: beatInterval / 2, volume: 0.8, isMain: false });
                    pattern.push({ time: beatInterval * 3 / 4, volume: 0.6, isMain: false });
                    break;
                case '5': // äº”è¿éŸ³
                    for (let i = 0; i < 5; i++) {
                        pattern.push({ 
                            time: beatInterval * i / 5, 
                            volume: i === 0 ? 1.0 : 0.7, 
                            isMain: i === 0 
                        });
                    }
                    break;
                case '6': // å…­è¿éŸ³
                    for (let i = 0; i < 6; i++) {
                        pattern.push({ 
                            time: beatInterval * i / 6, 
                            volume: i === 0 ? 1.0 : (i % 2 === 1 ? 0.7 : 0.5), 
                            isMain: i === 0 
                        });
                    }
                    break;
                case '7': // ä¸ƒè¿éŸ³
                    for (let i = 0; i < 7; i++) {
                        pattern.push({ 
                            time: beatInterval * i / 7, 
                            volume: i === 0 ? 1.0 : 0.6, 
                            isMain: i === 0 
                        });
                    }
                    break;
                case '8': // å…«ç­‰åˆ†
                    for (let i = 0; i < 8; i++) {
                        pattern.push({ 
                            time: beatInterval * i / 8, 
                            volume: i === 0 ? 1.0 : (i % 4 === 0 ? 0.8 : (i % 2 === 0 ? 0.6 : 0.5)), 
                            isMain: i === 0 
                        });
                    }
                    break;
                case 'dotted': // é™„ç‚¹éŸ³ç¬¦ï¼ˆ3:1æ¯”ä¾‹ï¼‰
                    pattern.push({ time: 0, volume: 1.0, isMain: true });
                    pattern.push({ time: beatInterval * 0.75, volume: 0.8, isMain: false });
                    break;
                case 'ddotted': // åŒé™„ç‚¹éŸ³ç¬¦ï¼ˆ7:1æ¯”ä¾‹ï¼‰
                    pattern.push({ time: 0, volume: 1.0, isMain: true });
                    pattern.push({ time: beatInterval * 0.875, volume: 0.7, isMain: false });
                    break;
                case 'eighth_dotted': // é™„ç‚¹å…«åˆ†éŸ³ç¬¦ï¼ˆ3:1æ¯”ä¾‹ï¼‰
                    pattern.push({ time: 0, volume: 1.0, isMain: true });
                    pattern.push({ time: beatInterval * 0.375, volume: 0.8, isMain: false });
                    pattern.push({ time: beatInterval * 0.625, volume: 0.8, isMain: false });
                    break;
                case 'swing': // æ‘‡æ‘†èŠ‚å¥ï¼ˆ2:1æ¯”ä¾‹ï¼‰
                    pattern.push({ time: 0, volume: 1.0, isMain: true });
                    pattern.push({ time: beatInterval * 0.666, volume: 0.8, isMain: false });
                    break;
                case 'triplet_duplet': // ä¸‰è¿äºŒ
                    pattern.push({ time: 0, volume: 1.0, isMain: true });
                    pattern.push({ time: beatInterval * 2 / 3, volume: 0.7, isMain: false });
                    pattern.push({ time: beatInterval * 4 / 3, volume: 0.8, isMain: false });
                    break;
                case 'rest': // ä¼‘æ­¢ç¬¦æ¨¡å¼
                    pattern.push({ time: 0, volume: 0, isMain: true }); // ç¬¬ä¸€ä¸ªéŸ³ç¬¦ä¼‘æ­¢
                    pattern.push({ time: beatInterval / 2, volume: 1.0, isMain: false });
                    break;
                default:
                    pattern.push({ time: 0, volume: 1.0, isMain: true });
            }
            
            return pattern;
        }
        
        // æ’­æ”¾ç»†åˆ†éŸ³æ¨¡å¼
        function playSubdivisionPattern(pattern, startTime, isFirstBeat, beatInterval) {
            pattern.forEach(note => {
                // è·³è¿‡éŸ³é‡ä¸º0çš„ä¼‘æ­¢ç¬¦
                if (note.volume === 0) {
                    return;
                }
                
                const now = startTime + note.time;
                
                // æ ¹æ®éŸ³è‰²å’Œæ˜¯å¦ä¸ºä¸»æ‹é€‰æ‹©åˆé€‚çš„éŸ³é¢‘ç¼“å†²åŒº
                let buffer;
                if (currentTone === 'standard') {
                    buffer = isFirstBeat && note.isMain ? soundBuffers.standardAccent : soundBuffers.standard;
                } else if (currentTone === 'electronic') {
                    buffer = isFirstBeat && note.isMain ? soundBuffers.electronicAccent : soundBuffers.electronic;
                } else if (currentTone === 'soft') {
                    buffer = isFirstBeat && note.isMain ? soundBuffers.softAccent : soundBuffers.soft;
                } else {
                    buffer = isFirstBeat && note.isMain ? soundBuffers.standardAccent : soundBuffers.standard;
                }
                
                // åˆ›å»ºç¼“å†²åŒºæºèŠ‚ç‚¹
                const source = audioContext.createBufferSource();
                source.buffer = buffer;
                
                // åˆ›å»ºçŸ­æ—¶é—´çš„åŒ…ç»œèŠ‚ç‚¹æ¥æ§åˆ¶å•ä¸ªéŸ³ç¬¦çš„éŸ³é‡
                const envelopeGain = audioContext.createGain();
                
                // æ ¹æ®éŸ³ç¬¦éŸ³é‡å’Œæ˜¯å¦ä¸ºä¸»æ‹è®¾ç½®éŸ³é‡
                const volume = currentVolume * note.volume * (note.isMain ? (isFirstBeat ? 1.2 : 1.0) : 0.9);
                
                // è®¾ç½®åŒ…ç»œ - ä½¿ç”¨æŒ‡æ•°å¹³æ»‘æ›²çº¿é¿å…å’”å—’å£°
                envelopeGain.gain.cancelScheduledValues(now);
                envelopeGain.gain.setValueAtTime(0.0001, now);
                envelopeGain.gain.exponentialRampToValueAtTime(volume, now + 0.002); // å¿«é€Ÿä¸Šå‡
                envelopeGain.gain.exponentialRampToValueAtTime(0.0001, now + 0.08); // æŒ‡æ•°è¡°å‡ç»“æŸï¼Œä½¿ç”¨0.0001é¿å…å¼‚å¸¸
                
                // è¿æ¥èŠ‚ç‚¹
                source.connect(envelopeGain);
                envelopeGain.connect(mainGainNode);
                
                // æ’­æ”¾å£°éŸ³
                source.start(now);
                source.stop(now + 0.1); // ç¡®ä¿åœæ­¢
                
                // æ¸…ç†å›è°ƒ
                source.onended = function() {
                    try {
                        source.disconnect();
                        envelopeGain.disconnect();
                    } catch (e) {}
                };
            });
        }

        toggleButton.addEventListener('click', function() {
            if (toggleButton.disabled) return;
            toggleButton.disabled = true;
            
            if (!isRunning) {
                startMetronome();
            } else {
                stopMetronome();
            }
            
            setTimeout(() => {
                toggleButton.disabled = false;
            }, 100);
        });
        
        // è°ƒåº¦å™¨å‡½æ•° - ä½¿ç”¨requestAnimationFrameå®ç°ç²¾ç¡®é¢„æ’
        function scheduler() {
            if (!isRunning || isStopping) return;
            
            if (!audioContext) return;
            
            // æ£€æŸ¥æ˜¯å¦éœ€è¦é¢„æ’æ›´å¤šèŠ‚æ‹
            const currentTime = audioContext.currentTime;
            
            // é¢„æ’æœªæ¥0.1ç§’å†…çš„èŠ‚æ‹
            while (nextBeatTime < currentTime + SCHEDULE_AHEAD_TIME) {
                // åœ¨ç¬¬ä¸€æ‹æ—¶åº”ç”¨æ–°çš„BPMå’Œæ‹æ•°
                if (currentBeatPosition === 1) {
                    // åº”ç”¨æ–°çš„BPM
                    if (isTrainingMode && trainingConfig.nextBpm !== undefined) {
                        trainingConfig.currentBpm = trainingConfig.nextBpm;
                        if (bpmSliderElement) {
                            bpmSliderElement.value = trainingConfig.currentBpm;
                            updateBPMDisplay(trainingConfig.currentBpm);
                        }
                        log('BPMå·²åœ¨æ–°å°èŠ‚å¼€å§‹æ—¶æ›´æ–°ä¸º', trainingConfig.currentBpm);
                        delete trainingConfig.nextBpm;
                    }
                    
                    // åº”ç”¨æ–°çš„æ‹æ•°ï¼ˆä»…åœ¨åˆ†æ®µè®­ç»ƒæ¨¡å¼ä¸‹ï¼‰
                    if (isTrainingMode && trainingModeType === 'segmented' && trainingConfig.nextBeatsPerBar !== undefined) {
                        setBeatsPerBar(trainingConfig.nextBeatsPerBar);
                        log('æ‹æ•°å·²åœ¨æ–°å°èŠ‚å¼€å§‹æ—¶æ›´æ–°ä¸º', trainingConfig.nextBeatsPerBar);
                        delete trainingConfig.nextBeatsPerBar;
                    }
                }
                
                // ä½¿ç”¨å½“å‰BPMå€¼è®¡ç®—èŠ‚æ‹é—´éš”
                const currentBpm = parseInt(bpmSliderElement.value);
                const beatInterval = 60 / currentBpm; // èŠ‚æ‹é—´éš”ï¼ˆç§’ï¼‰
                
                // å®‰æ’è¿™ä¸ªèŠ‚æ‹
                scheduleBeatAt(nextBeatTime);
                
                // æ›´æ–°ä¸‹ä¸€æ‹çš„æ—¶é—´
                nextBeatTime += beatInterval;
            }
            
            // ç»§ç»­è°ƒåº¦å™¨å¾ªç¯
            if (isRunning && !isStopping) {
                schedulerID = requestAnimationFrame(scheduler);
            }
        }
        
        // é¡¶å±‚çš„scheduleNextBeatå‡½æ•° - åˆå§‹åŒ–è°ƒåº¦å™¨
        function scheduleNextBeat() {
            if (!isRunning || isStopping) return;
            
            // åˆå§‹åŒ–ä¸‹ä¸€æ‹çš„æ—¶é—´
            if (audioContext) {
                nextBeatTime = audioContext.currentTime;
                
                // å¯åŠ¨è°ƒåº¦å™¨å¾ªç¯
                schedulerID = requestAnimationFrame(scheduler);
            }
        }
        
        function startMetronome() {
            isRunning = true;
            isStopping = false;
            
            // æ¸…é™¤ä¹‹å‰çš„è°ƒåº¦å™¨
            if (schedulerID !== null) {
                cancelAnimationFrame(schedulerID);
                schedulerID = null;
            }
            
            toggleButton.textContent = 'åœæ­¢';
            toggleButton.classList.remove('start');
            toggleButton.classList.add('stop');
            
            if (!audioContext) {
                audioContext = initAudioContext();
                if (!audioContext) {
                    alert('æ— æ³•åˆå§‹åŒ–éŸ³é¢‘ç³»ç»Ÿï¼Œè¯·ä½¿ç”¨æ”¯æŒWeb Audio APIçš„ç°ä»£æµè§ˆå™¨');
                    stopMetronome();
                    return;
                }
            }
            
            currentBeatPosition = 1;
            generateBeatIndicators();
            updateActiveIndicator();
            
            if (audioContext.state === 'suspended') {
                audioContext.resume().then(() => {
                    console.log('éŸ³é¢‘ä¸Šä¸‹æ–‡å·²æ¢å¤');
                    if (!isStopping && isRunning) {
                        // ç«‹å³æ’­æ”¾ä¸€ä¸ªèŠ‚æ‹
                        playBeat();
                        // åˆå§‹åŒ–ä¸‹ä¸€æ‹çš„æ—¶é—´
                        const bpm = parseInt(bpmSliderElement.value);
                        const beatInterval = 60 / bpm;
                        nextBeatTime = audioContext.currentTime + beatInterval;
                        // å¯åŠ¨è°ƒåº¦å™¨
                        schedulerID = requestAnimationFrame(scheduler);
                    }
                }).catch(e => {
                    console.error('æ¢å¤éŸ³é¢‘ä¸Šä¸‹æ–‡å¤±è´¥:', e);
                });
            } else {
                if (!isStopping && isRunning) {
                    // ç«‹å³æ’­æ”¾ä¸€ä¸ªèŠ‚æ‹
                    playBeat();
                    // åˆå§‹åŒ–ä¸‹ä¸€æ‹çš„æ—¶é—´
                    const bpm = parseInt(bpmSliderElement.value);
                    const beatInterval = 60 / bpm;
                    nextBeatTime = audioContext.currentTime + beatInterval;
                    // å¯åŠ¨è°ƒåº¦å™¨
                    schedulerID = requestAnimationFrame(scheduler);
                }
            }
            
            console.log('èŠ‚æ‹å™¨å·²å¯åŠ¨ï¼ŒBPM:', parseInt(bpmSliderElement.value));
        }
        
        function stopAllAudio() {
            // æ¸…é™¤è°ƒåº¦å™¨
            if (schedulerID !== null) {
                cancelAnimationFrame(schedulerID);
                schedulerID = null;
            }
            
            if (audioContext) {
                try {
                    const muteGain = audioContext.createGain();
                    muteGain.gain.setValueAtTime(0, audioContext.currentTime);
                    muteGain.connect(audioContext.destination);
                } catch (e) {
                    console.error('å¼ºåˆ¶åœæ­¢éŸ³é¢‘å‡ºé”™:', e);
                }
            }
        }

        function stopMetronome() {
            isStopping = true;
            isRunning = false;
            
            // æ¸…é™¤è°ƒåº¦å™¨
            if (schedulerID !== null) {
                cancelAnimationFrame(schedulerID);
                schedulerID = null;
            }
            
            stopAllAudio();
            
            toggleButton.textContent = 'å¼€å§‹';
            toggleButton.classList.remove('stop');
            toggleButton.classList.add('start');
            
            const dots = document.querySelectorAll('.beat-dot');
            dots.forEach(dot => dot.classList.remove('active'));
            
            setTimeout(() => {
                isStopping = false;
            }, 100);
            
            console.log('èŠ‚æ‹å™¨å·²åœæ­¢');
        }

        document.addEventListener('click', function initAudioOnUserInteraction() {
            if (!audioContext) {
                audioContext = initAudioContext();
                if (audioContext) {
                    audioContext.suspend();
                }
            }
        }, { once: true });

        const bpmDecreaseBtn = document.getElementById('bpm-decrease');
        const bpmIncreaseBtn = document.getElementById('bpm-increase');
        const tapBtn = document.getElementById('tap-btn');
        
        let tapTimes = [];
        let tapTimeout;
        const TAP_TIMEOUT_MS = 2000;
        
        let debounceTimer = null;
        
        function handleBPMChange(newBpm) {
            bpmValueElement.textContent = newBpm;
            bpmSliderElement.value = newBpm;
            
            clearTimeout(debounceTimer);
            
            debounceTimer = setTimeout(function() {
                if (isRunning) {
                    // æ¸…é™¤å½“å‰è°ƒåº¦å™¨
                    if (schedulerID !== null) {
                        cancelAnimationFrame(schedulerID);
                        schedulerID = null;
                    }
                    
                    // ç«‹å³æ’­æ”¾ä¸€ä¸ªèŠ‚æ‹
                    playBeat();
                    
                    // åˆå§‹åŒ–ä¸‹ä¸€æ‹çš„æ—¶é—´
                    const bpm = parseInt(bpmSliderElement.value);
                    const beatInterval = 60 / bpm;
                    nextBeatTime = audioContext.currentTime + beatInterval;
                    
                    // é‡æ–°å¯åŠ¨è°ƒåº¦å™¨
                    schedulerID = requestAnimationFrame(scheduler);
                    
                    console.log(`èŠ‚æ‹é€Ÿåº¦å·²æ›´æ–°ä¸º${newBpm} BPM`);
                }
            }, 150);
        }
        
        bpmSliderElement.addEventListener('input', function() {
            const newBpm = parseInt(this.value);
            handleBPMChange(newBpm);
        });
        
        bpmDecreaseBtn.addEventListener('click', function() {
            let currentBPM = parseInt(bpmSliderElement.value);
            if (currentBPM > 20) {
                currentBPM -= 1;
                handleBPMChange(currentBPM);
            }
        });
        
        tapBtn.addEventListener('click', function() {
            const now = Date.now();
            
            if (tapTimeout) {
                clearTimeout(tapTimeout);
            }
            
            tapTimes.push(now);
            
            if (tapTimes.length >= 2) {
                if (tapTimes.length > 5)
                {
                    tapTimes.shift();
                }
                
                const intervals = [];
                for (let i = 1; i < tapTimes.length; i++) {
                    intervals.push(tapTimes[i] - tapTimes[i - 1]);
                }
                
                const avgInterval = intervals.reduce((a, b) => a + b, 0) / intervals.length;
                const calculatedBPM = Math.round(60000 / avgInterval);
                
                if (calculatedBPM >= 20 && calculatedBPM <= 300) {
                    handleBPMChange(calculatedBPM);
                }
            }
            
            tapTimeout = setTimeout(function() {
                tapTimes = [];
            }, TAP_TIMEOUT_MS);
        });
        
        bpmIncreaseBtn.addEventListener('click', function() {
            let currentBPM = parseInt(bpmSliderElement.value);
            if (currentBPM < 300) {
                currentBPM += 1;
                handleBPMChange(currentBPM);
            }
        });
        
        const volumeValueElement = document.getElementById('volume-value');
        
        // éŸ³é‡æ§åˆ¶å·²ç§»è‡³controls.jsæ¨¡å—ä¸­ç»Ÿä¸€å¤„ç†
        // ä»…ä¿ç•™å€¼æ˜¾ç¤ºæ›´æ–°ï¼Œé¿å…ä¸æ¨¡å—åŒ–ä»£ç å†²çª
        volumeSliderElement.addEventListener('input', function() {
            const volumePercent = parseInt(this.value);
            volumeValueElement.textContent = volumePercent;
        });
        
        toneSelectorElement.addEventListener('change', function() {
            currentTone = this.value;
            console.log('éŸ³è‰²å·²åˆ‡æ¢ä¸º:', currentTone);
            
            // å¦‚æœéŸ³é¢‘ä¸Šä¸‹æ–‡å·²åˆå§‹åŒ–ï¼Œé‡æ–°ç”ŸæˆéŸ³é¢‘ç¼“å†²åŒº
            if (audioContext && mainGainNode) {
                generateSoundBuffers();
            }
        });
        
        beatNumeratorElement.addEventListener('change', function() {
            currentNumerator = parseInt(this.value);
            currentBeatPosition = 1;
            generateBeatIndicators();
            updateActiveIndicator();
            console.log(`èŠ‚æ‹æ¨¡å¼å·²æ›´æ”¹ä¸º: ${currentNumerator}/${currentDenominator}`);
        });
        
        // æ ¹æ®åˆ†æ¯å€¼è·å–å¯¹åº”çš„éŸ³ç¬¦å›¾æ ‡
        function getNoteIcon(denominator) {
            const iconMap = {
                1: 'ğ…',  // å…¨éŸ³ç¬¦
                2: 'ğ…—ğ…¥', // äºŒåˆ†éŸ³ç¬¦
                4: 'ğ…˜ğ…¥', // å››åˆ†éŸ³ç¬¦
                8: 'ğ…˜ğ…¥ğ…®', // å…«åˆ†éŸ³ç¬¦
                16: 'ğ…˜ğ…¥ğ…¯', // åå…­åˆ†éŸ³ç¬¦
                32: 'ğ…˜ğ…¥ğ…°'  // ä¸‰åäºŒåˆ†éŸ³ç¬¦
            };
            return iconMap[denominator] || 'ğ…˜ğ…¥';
        }
        
        // æ›´æ–°éŸ³ç¬¦å›¾æ ‡
        function updateNoteIcon() {
            const denominatorIcon = document.getElementById('denominator-icon');
            if (denominatorIcon) {
                denominatorIcon.textContent = getNoteIcon(currentDenominator);
            }
        }
        
        
        // æ·»åŠ è¿™ä¸ªæ–°å‡½æ•°
        function setBeatsPerBar(beats) {
            currentNumerator = parseInt(beats) || 4;
            if (beatNumeratorElement) {
                beatNumeratorElement.value = currentNumerator;
            }
            currentBeatPosition = 1;
            generateBeatIndicators();
            updateActiveIndicator();
            log('æ‹æ•°å·²è®¾ç½®ä¸º:', currentNumerator);
        }
        
        beatDenominatorElement.addEventListener('change', function() {
            currentDenominator = parseInt(this.value);
            currentBeatPosition = 1;
            generateBeatIndicators();
            updateActiveIndicator();
            updateNoteIcon(); // æ›´æ–°éŸ³ç¬¦å›¾æ ‡
            
            if (isRunning) {
                // æ¸…é™¤å½“å‰è°ƒåº¦å™¨
                if (schedulerID !== null) {
                    cancelAnimationFrame(schedulerID);
                    schedulerID = null;
                }
                
                // ç«‹å³æ’­æ”¾ä¸€ä¸ªèŠ‚æ‹
                playBeat();
                
                // åˆå§‹åŒ–ä¸‹ä¸€æ‹çš„æ—¶é—´
                const bpm = parseInt(bpmSliderElement.value);
                const beatInterval = 60 / bpm;
                nextBeatTime = audioContext.currentTime + beatInterval;
                
                // é‡æ–°å¯åŠ¨è°ƒåº¦å™¨
                schedulerID = requestAnimationFrame(scheduler);
            }
            
            console.log(`èŠ‚æ‹æ¨¡å¼å·²æ›´æ”¹ä¸º: ${currentNumerator}/${currentDenominator}`);
        });
        
        subdivisionElement.addEventListener('change', function() {
            currentSubdivision = this.value;
            console.log(`ç»†åˆ†éŸ³æ¨¡å¼å·²æ›´æ”¹ä¸º: ${currentSubdivision}`);
            
            // å¦‚æœèŠ‚æ‹å™¨æ­£åœ¨è¿è¡Œï¼Œéœ€è¦é‡æ–°åˆå§‹åŒ–æ’­æ”¾é—´éš”
            if (isRunning) {
                // æ¸…é™¤å½“å‰è°ƒåº¦å™¨
                if (schedulerID !== null) {
                    cancelAnimationFrame(schedulerID);
                    schedulerID = null;
                }
                
                // ç«‹å³æ’­æ”¾ä¸€ä¸ªèŠ‚æ‹
                playBeat();
                
                // åˆå§‹åŒ–ä¸‹ä¸€æ‹çš„æ—¶é—´
                const bpm = parseInt(bpmSliderElement.value);
                const beatInterval = 60 / bpm;
                nextBeatTime = audioContext.currentTime + beatInterval;
                
                // é‡æ–°å¯åŠ¨è°ƒåº¦å™¨
                schedulerID = requestAnimationFrame(scheduler);
            }
        });
        
        const resetBtn = document.getElementById('reset-btn');
        
        resetBtn.addEventListener('click', function() {
            if (isRunning) {
                stopMetronome();
            }
            
            const defaultBPM = 120;
            handleBPMChange(defaultBPM);
            
            // ä½¿ç”¨setVolumeå‡½æ•°ç»Ÿä¸€æ§åˆ¶éŸ³é‡ï¼Œé¿å…ä¸æ¨¡å—åŒ–ä»£ç å†²çª
            if (typeof setVolume === 'function') {
                setVolume(0.5); // 50%éŸ³é‡ï¼ˆå†…éƒ¨å·²è½¬æ¢ä¸º0-1èŒƒå›´ï¼‰
            } else {
                // é™çº§æ–¹æ¡ˆï¼šå¦‚æœsetVolumeä¸å¯ç”¨ï¼Œåˆ™ç›´æ¥è®¾ç½®
                volumeSliderElement.value = 50;
                volumeValueElement.textContent = 50;
            }
            
            toneSelectorElement.value = 'standard';
            currentTone = 'standard';
            
            beatNumeratorElement.value = 4;
            beatDenominatorElement.value = 4;
            subdivisionElement.value = '1';
            currentNumerator = 4;
            currentDenominator = 4;
            currentSubdivision = '1';
            updateNoteIcon(); // æ›´æ–°éŸ³ç¬¦å›¾æ ‡
            currentBeatPosition = 1;
            
            generateBeatIndicators();
            updateActiveIndicator();
            
            tapTimes = [];
            if (tapTimeout) {
                clearTimeout(tapTimeout);
            }
            
            console.log('èŠ‚æ‹å™¨å·²å¤ä½åˆ°é»˜è®¤è®¾ç½®');
        });

        // ç»„ä»¶æŸ¥çœ‹å™¨åŠŸèƒ½
        const inspectorToggle = document.getElementById('inspector-toggle');
        const componentInspector = document.querySelector('.component-inspector');
        const componentsContainer = document.getElementById('components-container');
        const refreshBtn = document.getElementById('refresh-inspector');
        const searchInput = document.getElementById('component-search');
        
        let currentHighlightedElement = null;
        
        inspectorToggle.addEventListener('click', function() {
            componentInspector.classList.toggle('active');
            if (componentInspector.classList.contains('active')) {
                updateComponentInfo();
            }
        });
        
        refreshBtn.addEventListener('click', function() {
            updateComponentInfo();
        });
        
        searchInput.addEventListener('input', function() {
            filterComponents(this.value);
        });
        
        function updateComponentInfo() {
            componentsContainer.innerHTML = '<div class="loading-message">æ­£åœ¨åŠ è½½ç»„ä»¶ä¿¡æ¯...</div>';
            
            setTimeout(() => {
                const components = gatherComponentInfo();
                displayComponents(components);
            }, 100);
        }
        
        function gatherComponentInfo() {
            const components = {
                controls: [],
                buttons: [],
                displays: [],
                inputs: [],
                training: [],
                indicators: []
            };
            
            // åŸºç¡€æ§åˆ¶å™¨
            const bpmSlider = document.getElementById('bpm-slider');
            if (bpmSlider) {
                components.controls.push({
                    name: 'BPMæ»‘å—',
                    type: 'range',
                    id: 'bpm-slider',
                    value: bpmSlider.value,
                    min: bpmSlider.min,
                    max: bpmSlider.max,
                    element: bpmSlider
                });
            }
            
            const volumeSlider = document.getElementById('volume-slider');
            if (volumeSlider) {
                components.controls.push({
                    name: 'éŸ³é‡æ»‘å—',
                    type: 'range',
                    id: 'volume-slider',
                    value: volumeSlider.value + '%',
                    min: volumeSlider.min,
                    max: volumeSlider.max,
                    element: volumeSlider
                });
            }
            
            // éŸ³è‰²å’ŒèŠ‚æ‹è®¾ç½®
            const toneSelector = document.getElementById('tone-selector');
            if (toneSelector) {
                components.inputs.push({
                    name: 'éŸ³è‰²é€‰æ‹©å™¨',
                    type: 'select',
                    id: 'tone-selector',
                    value: toneSelector.options[toneSelector.selectedIndex].text,
                    options: Array.from(toneSelector.options).map(opt => opt.text).join(', '),
                    element: toneSelector
                });
            }
            
            const beatNumerator = document.getElementById('beat-numerator');
            if (beatNumerator) {
                components.inputs.push({
                    name: 'èŠ‚æ‹åˆ†å­',
                    type: 'select',
                    id: 'beat-numerator',
                    value: beatNumerator.value,
                    element: beatNumerator
                });
            }
            
            const beatDenominator = document.getElementById('beat-denominator');
            if (beatDenominator) {
                components.inputs.push({
                    name: 'èŠ‚æ‹åˆ†æ¯',
                    type: 'select',
                    id: 'beat-denominator',
                    value: beatDenominator.value,
                    element: beatDenominator
                });
            }
            
            const subdivisionElement = document.getElementById('subdivision');
            if (subdivisionElement) {
                components.inputs.push({
                    name: 'ç»†åˆ†é€‰æ‹©å™¨',
                    type: 'select',
                    id: 'subdivision',
                    value: subdivisionElement.options[subdivisionElement.selectedIndex].text,
                    element: subdivisionElement
                });
            }
            
            // æŒ‰é’®
            const toggleBtn = document.getElementById('toggle-btn');
            if (toggleBtn) {
                components.buttons.push({
                    name: 'å¼€å§‹/åœæ­¢æŒ‰é’®',
                    type: 'button',
                    id: 'toggle-btn',
                    state: isRunning ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢',
                    text: toggleBtn.textContent,
                    element: toggleBtn
                });
            }
            
            const tapBtn = document.getElementById('tap-btn');
            if (tapBtn) {
                components.buttons.push({
                    name: 'TAPæŒ‰é’®',
                    type: 'button',
                    id: 'tap-btn',
                    text: tapBtn.textContent,
                    element: tapBtn
                });
            }
            
            const resetBtn = document.getElementById('reset-btn');
            if (resetBtn) {
                components.buttons.push({
                    name: 'å¤ä½æŒ‰é’®',
                    type: 'button',
                    id: 'reset-btn',
                    text: resetBtn.textContent,
                    element: resetBtn
                });
            }
            
            // æ˜¾ç¤ºå…ƒç´ 
            const bpmDisplay = document.getElementById('bpm-value');
            if (bpmDisplay) {
                components.displays.push({
                    name: 'BPMæ˜¾ç¤º',
                    type: 'display',
                    id: 'bpm-value',
                    value: bpmDisplay.textContent,
                    element: bpmDisplay
                });
            }
            
            const volumeDisplay = document.getElementById('volume-value');
            if (volumeDisplay) {
                components.displays.push({
                    name: 'éŸ³é‡æ˜¾ç¤º',
                    type: 'display',
                    id: 'volume-value',
                    value: volumeDisplay.textContent + '%',
                    element: volumeDisplay
                });
            }
            
            // æŒ‡ç¤ºå™¨
            const indicatorDotsElement = document.getElementById('indicator-dots');
            if (indicatorDotsElement) {
                components.indicators.push({
                    name: 'èŠ‚æ‹æŒ‡ç¤ºå™¨',
                    type: 'indicator',
                    id: 'indicator-dots',
                    totalDots: indicatorDotsElement.children.length,
                    element: indicatorDotsElement
                });
            }
            
            // è®­ç»ƒæ¨¡å¼ç›¸å…³ç»„ä»¶
            const trainingBtn = document.getElementById('training-btn');
            if (trainingBtn) {
                components.training.push({
                    name: 'è®­ç»ƒæŒ‰é’®',
                    type: 'button',
                    id: 'training-btn',
                    text: trainingBtn.textContent,
                    element: trainingBtn
                });
            }
            
            const trainingStatusText = document.getElementById('training-status-text');
            if (trainingStatusText) {
                components.training.push({
                    name: 'è®­ç»ƒçŠ¶æ€æ˜¾ç¤º',
                    type: 'display',
                    id: 'training-status-text',
                    value: trainingStatusText.textContent,
                    element: trainingStatusText
                });
            }
            
            const trainingBpmValue = document.getElementById('training-bpm-value');
            if (trainingBpmValue) {
                components.training.push({
                    name: 'è®­ç»ƒBPMæ˜¾ç¤º',
                    type: 'display',
                    id: 'training-bpm-value',
                    value: trainingBpmValue.textContent,
                    element: trainingBpmValue
                });
            }
            
            const barsCompletedElement = document.getElementById('bars-completed');
            if (barsCompletedElement) {
                components.training.push({
                    name: 'å·²å®Œæˆå°èŠ‚æ•°',
                    type: 'display',
                    id: 'bars-completed',
                    value: barsCompletedElement.textContent,
                    element: barsCompletedElement
                });
            }
            
            const barsUntilChangeElement = document.getElementById('bars-until-change');
            if (barsUntilChangeElement) {
                components.training.push({
                    name: 'å‰©ä½™å°èŠ‚æ•°',
                    type: 'display',
                    id: 'bars-until-change',
                    value: barsUntilChangeElement.textContent,
                    element: barsUntilChangeElement
                });
            }
            
            // æ¨¡æ€çª—å£ç›¸å…³ç»„ä»¶
            const trainingModal = document.getElementById('training-modal');
            if (trainingModal) {
                components.training.push({
                    name: 'è®­ç»ƒæ¨¡æ€çª—å£',
                    type: 'modal',
                    id: 'training-modal',
                    visible: trainingModal.style.display === 'block' ? 'å¯è§' : 'éšè—',
                    element: trainingModal
                });
            }
            
            return components;
        }
        
        function displayComponents(components) {
            let html = '';
            
            const totalComponents = components.controls.length + components.buttons.length + 
                                   components.displays.length + components.inputs.length +
                                   components.training.length + components.indicators.length;
            
            // æ”¶é›†æ›´å¤šç»Ÿè®¡ä¿¡æ¯
            const bpm = document.getElementById('bpm-value')?.textContent || 'æœªçŸ¥';
            const currentTime = new Date().toLocaleTimeString();
            
            html += `
                <div class="stats-section">
                    <div class="stats-header">ç³»ç»Ÿä¿¡æ¯</div>
                    <div class="stats-content">
                        <span>æ€»ç»„ä»¶æ•°: ${totalComponents}</span>
                        <span>è¿è¡ŒçŠ¶æ€: ${isRunning ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢'}</span>
                    </div>
                    <div class="stats-content">
                        <span>å½“å‰BPM: ${bpm}</span>
                        <span>è®­ç»ƒæ¨¡å¼: ${isTrainingMode ? 'å·²æ¿€æ´»' : 'æœªæ¿€æ´»'}</span>
                    </div>
                    <div class="stats-content">
                        <span>å½“å‰æ—¶é—´: ${currentTime}</span>
                        <span>éŸ³é¢‘çŠ¶æ€: ${audioContext?.state || 'æœªåˆå§‹åŒ–'}</span>
                    </div>
                </div>
                
                <div class="stats-section">
                    <div class="stats-header">ç»„ä»¶åˆ†å¸ƒ</div>
                    <div class="stats-content">
                        <span>æ§åˆ¶å™¨: ${components.controls.length}</span>
                        <span>æŒ‰é’®: ${components.buttons.length}</span>
                    </div>
                    <div class="stats-content">
                        <span>æ˜¾ç¤ºå…ƒç´ : ${components.displays.length}</span>
                        <span>è¾“å…¥å…ƒç´ : ${components.inputs.length}</span>
                    </div>
                    <div class="stats-content">
                        <span>è®­ç»ƒç»„ä»¶: ${components.training.length}</span>
                        <span>æŒ‡ç¤ºå™¨: ${components.indicators.length}</span>
                    </div>
                </div>
                
                <!-- è¿‡æ»¤å™¨æ§ä»¶ -->
                <div class="filter-controls">
                    <select id="type-filter">
                        <option value="all">æ‰€æœ‰ç±»å‹</option>
                        <option value="range">æ»‘å—</option>
                        <option value="button">æŒ‰é’®</option>
                        <option value="display">æ˜¾ç¤º</option>
                        <option value="select">é€‰æ‹©å™¨</option>
                        <option value="modal">æ¨¡æ€çª—å£</option>
                        <option value="indicator">æŒ‡ç¤ºå™¨</option>
                    </select>
                    <select id="state-filter">
                        <option value="all">æ‰€æœ‰çŠ¶æ€</option>
                        <option value="visible">å¯è§</option>
                        <option value="hidden">éšè—</option>
                    </select>
                </div>
            `;
            
            // æ·»åŠ å¯æŠ˜å ç»„ä»¶ç»„
            if (components.controls.length > 0) {
                html += `
                <div class="component-group">
                    <div class="group-header" onclick="toggleComponentGroup(this)">
                        <h3>æ§åˆ¶å™¨</h3>
                        <span class="toggle-icon">â–¼</span>
                    </div>
                    <div class="group-content">`;
                components.controls.forEach(comp => {
                    html += createComponentHTML(comp);
                });
                html += `</div></div>`;
            }
            
            if (components.buttons.length > 0) {
                html += `
                <div class="component-group">
                    <div class="group-header" onclick="toggleComponentGroup(this)">
                        <h3>æŒ‰é’®</h3>
                        <span class="toggle-icon">â–¼</span>
                    </div>
                    <div class="group-content">`;
                components.buttons.forEach(comp => {
                    html += createComponentHTML(comp);
                });
                html += `</div></div>`;
            }
            
            if (components.displays.length > 0) {
                html += `
                <div class="component-group">
                    <div class="group-header" onclick="toggleComponentGroup(this)">
                        <h3>æ˜¾ç¤ºå…ƒç´ </h3>
                        <span class="toggle-icon">â–¼</span>
                    </div>
                    <div class="group-content">`;
                components.displays.forEach(comp => {
                    html += createComponentHTML(comp);
                });
                html += `</div></div>`;
            }
            
            if (components.inputs.length > 0) {
                html += `
                <div class="component-group">
                    <div class="group-header" onclick="toggleComponentGroup(this)">
                        <h3>è¾“å…¥å…ƒç´ </h3>
                        <span class="toggle-icon">â–¼</span>
                    </div>
                    <div class="group-content">`;
                components.inputs.forEach(comp => {
                    html += createComponentHTML(comp);
                });
                html += `</div></div>`;
            }
            
            if (components.indicators.length > 0) {
                html += `
                <div class="component-group">
                    <div class="group-header" onclick="toggleComponentGroup(this)">
                        <h3>æŒ‡ç¤ºå™¨</h3>
                        <span class="toggle-icon">â–¼</span>
                    </div>
                    <div class="group-content">`;
                components.indicators.forEach(comp => {
                    html += createComponentHTML(comp);
                });
                html += `</div></div>`;
            }
            
            if (components.training.length > 0) {
                html += `
                <div class="component-group">
                    <div class="group-header" onclick="toggleComponentGroup(this)">
                        <h3>è®­ç»ƒç»„ä»¶</h3>
                        <span class="toggle-icon">â–¼</span>
                    </div>
                    <div class="group-content">`;
                components.training.forEach(comp => {
                    html += createComponentHTML(comp);
                });
                html += `</div></div>`;
            }
            
            componentsContainer.innerHTML = html;
            
            attachComponentClickHandlers();
            
            // æ·»åŠ è¿‡æ»¤å™¨äº‹ä»¶ç›‘å¬
            document.getElementById('type-filter')?.addEventListener('change', updateFilter);
            document.getElementById('state-filter')?.addEventListener('change', updateFilter);
        }
        
        // åˆ‡æ¢ç»„ä»¶ç»„æŠ˜å çŠ¶æ€
        function toggleComponentGroup(header) {
            const content = header.nextElementSibling;
            const icon = header.querySelector('.toggle-icon');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.textContent = 'â–¼';
            } else {
                content.style.display = 'none';
                icon.textContent = 'â–¶';
            }
        }
        
        // æ›´æ–°è¿‡æ»¤å™¨
        function updateFilter() {
            const searchTerm = document.getElementById('component-search').value;
            filterComponents(searchTerm);
        }
        
        function createComponentHTML(comp) {
            // æ·»åŠ å®æ—¶æ—¶é—´æˆ³
            const timestamp = new Date().toLocaleTimeString();
            let infoRows = `
                <div class="info-row">
                    <span class="info-label">ç±»å‹:</span>
                    <span class="info-value">${comp.type}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">ID:</span>
                    <span class="info-value">${comp.id}</span>
                </div>
            `;
            
            if (comp.value !== undefined) {
                infoRows += `
                    <div class="info-row">
                        <span class="info-label">å½“å‰å€¼:</span>
                        <span class="info-value value-display" data-component-id="${comp.id}">${comp.value}</span>
                    </div>
                `;
            }
            
            if (comp.min !== undefined && comp.max !== undefined) {
                infoRows += `
                    <div class="info-row">
                        <span class="info-label">èŒƒå›´:</span>
                        <span class="info-value">${comp.min} - ${comp.max}</span>
                    </div>
                `;
            }
            
            if (comp.state !== undefined) {
                infoRows += `
                    <div class="info-row">
                        <span class="info-label">çŠ¶æ€:</span>
                        <span class="info-value state-display" data-component-id="${comp.id}">${comp.state}</span>
                    </div>
                `;
            }
            
            if (comp.text !== undefined) {
                infoRows += `
                    <div class="info-row">
                        <span class="info-label">æ–‡æœ¬:</span>
                        <span class="info-value">${comp.text}</span>
                    </div>
                `;
            }
            
            if (comp.options !== undefined) {
                infoRows += `
                    <div class="info-row">
                        <span class="info-label">é€‰é¡¹:</span>
                        <span class="info-value">${comp.options}</span>
                    </div>
                `;
            }
            
            if (comp.totalDots !== undefined) {
                infoRows += `
                    <div class="info-row">
                        <span class="info-label">æ€»ç‚¹æ•°:</span>
                        <span class="info-value">${comp.totalDots}</span>
                    </div>
                `;
            }
            
            if (comp.visible !== undefined) {
                infoRows += `
                    <div class="info-row">
                        <span class="info-label">å¯è§æ€§:</span>
                        <span class="info-value">${comp.visible}</span>
                    </div>
                `;
            }
            
            // æ·»åŠ å…ƒç´ çŠ¶æ€ä¿¡æ¯
            if (comp.element) {
                const isVisible = comp.element.offsetParent !== null ? 'å¯è§' : 'éšè—';
                const isDisabled = comp.element.disabled ? 'å·²ç¦ç”¨' : 'å¯ç”¨';
                
                infoRows += `
                    <div class="info-row">
                        <span class="info-label">å…ƒç´ å¯è§æ€§:</span>
                        <span class="info-value visibility-display" data-component-id="${comp.id}">${isVisible}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">äº¤äº’çŠ¶æ€:</span>
                        <span class="info-value">${isDisabled}</span>
                    </div>
                `;
            }
            
            // æ·»åŠ æ›´æ–°æ—¶é—´æˆ³
            infoRows += `
                <div class="info-row timestamp-row">
                    <span class="info-label">æ›´æ–°æ—¶é—´:</span>
                    <span class="info-value">${timestamp}</span>
                </div>
            `;
            
            // è·å–ç»„ä»¶çŠ¶æ€æŒ‡ç¤ºå™¨
            const isVisible = comp.element ? (comp.element.offsetParent !== null ? 'visible' : 'hidden') : 'unknown';
            
            return `
                <div class="component-item" data-component-id="${comp.id}">
                    <div class="component-header">
                        <div class="component-title">${comp.name}</div>
                        <span class="component-indicator" data-status="${isVisible}"></span>
                    </div>
                    <div class="component-info">
                        ${infoRows}
                    </div>
                    <div class="component-actions">
                        <button class="refresh-btn" data-target="${comp.id}">åˆ·æ–°</button>
                        <button class="highlight-btn" data-target="${comp.id}">é«˜äº®</button>
                        <button class="inspect-btn" data-target="${comp.id}">æ£€æŸ¥</button>
                    </div>
                </div>
            `;
        }
        
        function attachComponentClickHandlers() {
            // åˆ·æ–°æŒ‰é’®ç‚¹å‡»å¤„ç†
            document.querySelectorAll('.refresh-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const componentId = this.getAttribute('data-target');
                    refreshSingleComponent(componentId);
                });
            });
            
            // é«˜äº®æŒ‰é’®ç‚¹å‡»å¤„ç†
            document.querySelectorAll('.highlight-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const componentId = this.getAttribute('data-target');
                    highlightElement(componentId);
                });
            });
            
            // æ£€æŸ¥æŒ‰é’®ç‚¹å‡»å¤„ç†
            document.querySelectorAll('.inspect-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const componentId = this.getAttribute('data-target');
                    inspectElement(componentId);
                });
            });
            
            // ç»„ä»¶é¡¹ç‚¹å‡»å¤„ç†
            document.querySelectorAll('.component-item').forEach(item => {
                item.addEventListener('click', function() {
                    const componentId = this.getAttribute('data-component-id');
                    highlightElement(componentId);
                });
            });
        }
        
        // åˆ·æ–°å•ä¸ªç»„ä»¶ä¿¡æ¯
        function refreshSingleComponent(componentId) {
            // æ”¶é›†ç»„ä»¶æœ€æ–°ä¿¡æ¯
            const componentInfo = gatherComponentInfo();
            
            // ä»æ‰€æœ‰ç»„ä»¶ä¸­æŸ¥æ‰¾ç›®æ ‡ç»„ä»¶
            let updatedComp = null;
            for (const groupKey in componentInfo) {
                const group = componentInfo[groupKey];
                for (const comp of group) {
                    if (comp.id === componentId) {
                        updatedComp = comp;
                        break;
                    }
                }
                if (updatedComp) break;
            }
            
            if (updatedComp) {
                // æ›´æ–°ç»„ä»¶æ˜¾ç¤ºä¿¡æ¯
                const componentElement = document.querySelector(`.component-item[data-component-id="${componentId}"]`);
                if (componentElement) {
                    // æ›´æ–°å€¼æ˜¾ç¤º
                    const valueDisplay = componentElement.querySelector('.value-display[data-component-id="' + componentId + '"]');
                    if (valueDisplay && updatedComp.value !== undefined) {
                        valueDisplay.textContent = updatedComp.value;
                        // æ·»åŠ é—ªçƒæ•ˆæœ
                        valueDisplay.classList.add('updated');
                        setTimeout(() => valueDisplay.classList.remove('updated'), 1000);
                    }
                    
                    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                    const stateDisplay = componentElement.querySelector('.state-display[data-component-id="' + componentId + '"]');
                    if (stateDisplay && updatedComp.state !== undefined) {
                        stateDisplay.textContent = updatedComp.state;
                        stateDisplay.classList.add('updated');
                        setTimeout(() => stateDisplay.classList.remove('updated'), 1000);
                    }
                    
                    // æ›´æ–°å¯è§æ€§æ˜¾ç¤º
                    const visibilityDisplay = componentElement.querySelector('.visibility-display[data-component-id="' + componentId + '"]');
                    if (visibilityDisplay && updatedComp.element) {
                        const isVisible = updatedComp.element.offsetParent !== null ? 'å¯è§' : 'éšè—';
                        visibilityDisplay.textContent = isVisible;
                        visibilityDisplay.classList.add('updated');
                        setTimeout(() => visibilityDisplay.classList.remove('updated'), 1000);
                    }
                    
                    // æ›´æ–°æ—¶é—´æˆ³
                    const timestampRow = componentElement.querySelector('.timestamp-row .info-value');
                    if (timestampRow) {
                        timestampRow.textContent = new Date().toLocaleTimeString();
                    }
                    
                    // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
                    const indicator = componentElement.querySelector('.component-indicator');
                    if (indicator && updatedComp.element) {
                        const status = updatedComp.element.offsetParent !== null ? 'visible' : 'hidden';
                        indicator.setAttribute('data-status', status);
                    }
                }
                
                console.log('ç»„ä»¶å·²åˆ·æ–°:', componentId);
            }
        }
        
        function inspectElement(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                // é«˜äº®å…ƒç´ 
                highlightElement(elementId);
                
                // æ”¶é›†è¯¦ç»†ä¿¡æ¯
                const rect = element.getBoundingClientRect();
                const computedStyle = window.getComputedStyle(element);
                
                // åˆ›å»ºæ¨¡æ€æ¡†
                createInspectionModal({
                    id: elementId,
                    tagName: element.tagName.toLowerCase(),
                    dimensions: {
                        width: Math.round(rect.width),
                        height: Math.round(rect.height),
                        left: Math.round(rect.left),
                        top: Math.round(rect.top)
                    },
                    visibility: element.offsetParent !== null ? 'å¯è§' : 'éšè—',
                    classes: element.className || 'æ— ',
                    style: {
                        display: computedStyle.display,
                        visibility: computedStyle.visibility,
                        position: computedStyle.position,
                        zIndex: computedStyle.zIndex
                    },
                    attributes: getElementAttributes(element),
                    textContent: truncateText(element.textContent, 100),
                    childCount: element.childElementCount,
                    hasEventListeners: hasAttachedEventListeners(element)
                });
                
                console.log('å·²å¯åŠ¨å…ƒç´ æ£€æŸ¥:', elementId);
            }
        }
        
        function getElementAttributes(element) {
            const attributes = {};
            for (let i = 0; i < element.attributes.length; i++) {
                const attr = element.attributes[i];
                attributes[attr.name] = attr.value;
            }
            return attributes;
        }
        
        function truncateText(text, maxLength) {
            if (!text || text.length <= maxLength) return text || '';
            return text.substring(0, maxLength) + '...';
        }
        
        function hasAttachedEventListeners(element) {
            // ç®€å•æ£€æŸ¥æ˜¯å¦æœ‰å¸¸è§çš„äº‹ä»¶å¤„ç†å±æ€§
            const eventAttributes = ['onclick', 'onchange', 'oninput', 'onmouseover', 'onmouseout'];
            return eventAttributes.some(attr => element.hasAttribute(attr) && element.getAttribute(attr).trim() !== '');
        }
        
        function createInspectionModal(elementInfo) {
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰æ¨¡æ€æ¡†ï¼Œå¦‚æœæœ‰åˆ™ç§»é™¤
            let modal = document.getElementById('element-inspection-modal');
            if (modal) {
                modal.remove();
            }
            
            // åˆ›å»ºæ–°çš„æ¨¡æ€æ¡†
            modal = document.createElement('div');
            modal.id = 'element-inspection-modal';
            modal.className = 'inspection-modal';
            
            // æ„å»ºå±æ€§ä¿¡æ¯HTML
            let attributesHtml = '';
            for (const [name, value] of Object.entries(elementInfo.attributes)) {
                attributesHtml += `<div class="attr-item">
                    <span class="attr-name">${name}</span>
                    <span class="attr-value">${value}</span>
                </div>`;
            }
            
            modal.innerHTML = `
                <div class="modal-backdrop" id="modal-backdrop"></div>
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>å…ƒç´ æ£€æŸ¥å™¨</h3>
                        <button class="close-btn" id="close-inspection-modal">Ã—</button>
                    </div>
                    
                    <div class="modal-body">
                        <div class="info-section">
                            <h4>åŸºæœ¬ä¿¡æ¯</h4>
                            <div class="info-grid">
                                <div class="info-item">
                                    <span class="info-label">å…ƒç´ ID:</span>
                                    <span class="info-value">${elementInfo.id}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">æ ‡ç­¾å:</span>
                                    <span class="info-value">${elementInfo.tagName}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">å°ºå¯¸:</span>
                                    <span class="info-value">${elementInfo.dimensions.width}x${elementInfo.dimensions.height}px</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">ä½ç½®:</span>
                                    <span class="info-value">(${elementInfo.dimensions.left}, ${elementInfo.dimensions.top})px</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">å¯è§æ€§:</span>
                                    <span class="info-value">${elementInfo.visibility}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">å­å…ƒç´ æ•°:</span>
                                    <span class="info-value">${elementInfo.childCount}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="info-section">
                            <h4>CSSä¿¡æ¯</h4>
                            <div class="info-grid">
                                <div class="info-item">
                                    <span class="info-label">CSSç±»:</span>
                                    <span class="info-value">${elementInfo.classes}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">display:</span>
                                    <span class="info-value">${elementInfo.style.display}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">visibility:</span>
                                    <span class="info-value">${elementInfo.style.visibility}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">position:</span>
                                    <span class="info-value">${elementInfo.style.position}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">z-index:</span>
                                    <span class="info-value">${elementInfo.style.zIndex}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="info-section">
                            <h4>å±æ€§</h4>
                            <div class="attributes-container">
                                ${attributesHtml || '<div class="no-attributes">æ— è‡ªå®šä¹‰å±æ€§</div>'}
                            </div>
                        </div>
                        
                        ${elementInfo.textContent ? `
                        <div class="info-section">
                            <h4>æ–‡æœ¬å†…å®¹</h4>
                            <div class="text-content">${elementInfo.textContent}</div>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="modal-footer">
                        <button class="action-btn" id="highlight-again-btn">å†æ¬¡é«˜äº®å…ƒç´ </button>
                        <button class="action-btn close-btn" id="close-btn">å…³é—­</button>
                    </div>
                </div>
            `;
            
            // æ·»åŠ æ¨¡æ€æ¡†æ ·å¼
            const style = document.createElement('style');
            style.textContent = `
                .inspection-modal {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    z-index: 2000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                }
                
                .modal-backdrop {
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0, 0, 0, 0.5);
                }
                
                .modal-content {
                    position: relative;
                    background-color: white;
                    border-radius: 8px;
                    width: 90%;
                    max-width: 600px;
                    max-height: 80vh;
                    display: flex;
                    flex-direction: column;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                    animation: modalFadeIn 0.3s ease-out;
                }
                
                @keyframes modalFadeIn {
                    from {
                        opacity: 0;
                        transform: translateY(-20px);
                    }
                    to {
                        opacity: 1;
                        transform: translateY(0);
                    }
                }
                
                .modal-header {
                    padding: 15px 20px;
                    border-bottom: 1px solid #eee;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    background-color: #f8f9fa;
                    border-radius: 8px 8px 0 0;
                }
                
                .modal-header h3 {
                    margin: 0;
                    color: #333;
                    font-size: 18px;
                }
                
                .close-btn {
                    background: none;
                    border: none;
                    font-size: 24px;
                    cursor: pointer;
                    color: #666;
                    padding: 0;
                    width: 30px;
                    height: 30px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    border-radius: 4px;
                    transition: all 0.2s;
                }
                
                .close-btn:hover {
                    background-color: #eee;
                    color: #333;
                }
                
                .modal-body {
                    padding: 20px;
                    overflow-y: auto;
                    flex: 1;
                }
                
                .info-section {
                    margin-bottom: 25px;
                }
                
                .info-section h4 {
                    margin: 0 0 12px 0;
                    color: #555;
                    font-size: 16px;
                    font-weight: 500;
                    border-bottom: 1px solid #eee;
                    padding-bottom: 8px;
                }
                
                .info-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                    gap: 10px;
                }
                
                .info-item {
                    display: flex;
                    justify-content: space-between;
                    padding: 6px 0;
                    border-bottom: 1px solid #f0f0f0;
                }
                
                .info-label {
                    font-weight: 500;
                    color: #666;
                    font-size: 14px;
                }
                
                .info-value {
                    color: #333;
                    font-size: 14px;
                    font-family: monospace;
                }
                
                .attributes-container {
                    max-height: 200px;
                    overflow-y: auto;
                    border: 1px solid #eee;
                    border-radius: 4px;
                }
                
                .attr-item {
                    display: flex;
                    justify-content: space-between;
                    padding: 8px 12px;
                    border-bottom: 1px solid #f0f0f0;
                    font-size: 14px;
                }
                
                .attr-item:last-child {
                    border-bottom: none;
                }
                
                .attr-name {
                    font-weight: 500;
                    color: #3498db;
                }
                
                .attr-value {
                    font-family: monospace;
                    color: #2ecc71;
                }
                
                .no-attributes {
                    padding: 20px;
                    text-align: center;
                    color: #999;
                    font-style: italic;
                }
                
                .text-content {
                    padding: 10px;
                    background-color: #f8f9fa;
                    border-radius: 4px;
                    font-family: monospace;
                    font-size: 14px;
                    max-height: 120px;
                    overflow-y: auto;
                    white-space: pre-wrap;
                    word-break: break-all;
                }
                
                .modal-footer {
                    padding: 15px 20px;
                    border-top: 1px solid #eee;
                    display: flex;
                    justify-content: flex-end;
                    gap: 10px;
                    background-color: #f8f9fa;
                    border-radius: 0 0 8px 8px;
                }
                
                .action-btn {
                    padding: 8px 16px;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 14px;
                    transition: all 0.2s;
                }
                
                #highlight-again-btn {
                    background-color: #3498db;
                    color: white;
                }
                
                #highlight-again-btn:hover {
                    background-color: #2980b9;
                }
                
                #close-btn {
                    background-color: #6c757d;
                    color: white;
                }
                
                #close-btn:hover {
                    background-color: #5a6268;
                }
            `;
            
            document.body.appendChild(style);
            document.body.appendChild(modal);
            
            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            document.getElementById('close-inspection-modal').addEventListener('click', closeModal);
            document.getElementById('close-btn').addEventListener('click', closeModal);
            document.getElementById('highlight-again-btn').addEventListener('click', () => {
                highlightElement(elementInfo.id);
            });
            
            document.getElementById('modal-backdrop').addEventListener('click', closeModal);
            
            // æŒ‰ESCé”®å…³é—­æ¨¡æ€æ¡†
            document.addEventListener('keydown', handleEscKey);
            
            function closeModal() {
                modal.remove();
                document.removeEventListener('keydown', handleEscKey);
            }
            
            function handleEscKey(event) {
                if (event.key === 'Escape') {
                    closeModal();
                }
            }
        }
        
        function highlightElement(elementId) {
            if (currentHighlightedElement) {
                currentHighlightedElement.classList.remove('highlighted-element');
                currentHighlightedElement = null;
            }
            
            const element = document.getElementById(elementId);
            if (element) {
                // è®°å½•åŸå§‹æ ·å¼ï¼Œä»¥ä¾¿åœ¨é«˜äº®ç»“æŸåæ¢å¤
                const originalStyle = element.style.cssText;
                
                // æ»šåŠ¨åˆ°å…ƒç´ å¯è§åŒºåŸŸ
                element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // æ·»åŠ é«˜äº®ç±»
                element.classList.add('highlighted-element');
                currentHighlightedElement = element;
                
                // æ·»åŠ é¢å¤–çš„è§†è§‰æ•ˆæœ
                element.style.transition = 'all 0.3s ease';
                
                // æ˜¾ç¤ºé«˜äº®æç¤º
                const tooltip = document.createElement('div');
                tooltip.textContent = `é«˜äº®å…ƒç´ : ${elementId}`;
                tooltip.style.cssText = `
                    position: absolute;
                    background-color: #3498db;
                    color: white;
                    padding: 4px 10px;
                    border-radius: 4px;
                    font-size: 12px;
                    z-index: 1001;
                    pointer-events: none;
                    white-space: nowrap;
                    animation: fadeInOut 3s ease-in-out;
                `;
                document.body.appendChild(tooltip);
                
                // å®šä½æç¤ºæ¡†
                const rect = element.getBoundingClientRect();
                tooltip.style.left = `${rect.left + window.scrollX}px`;
                tooltip.style.top = `${rect.top - 30 + window.scrollY}px`;
                
                // 3ç§’åè‡ªåŠ¨ç§»é™¤é«˜äº®
                setTimeout(() => {
                    if (currentHighlightedElement === element) {
                        element.classList.remove('highlighted-element');
                        element.style.cssText = originalStyle;
                        currentHighlightedElement = null;
                        
                        // ç§»é™¤æç¤ºæ¡†
                        if (tooltip.parentNode) {
                            tooltip.parentNode.removeChild(tooltip);
                        }
                        
                        console.log(`å·²ç§»é™¤å…ƒç´  ${elementId} çš„é«˜äº®`);
                    }
                }, 3000);
                
                console.log(`å·²é«˜äº®å…ƒç´ : ${elementId}`);
            }
        }
        
        // æ·»åŠ åŠ¨ç”»æ ·å¼
        const animationStyle = document.createElement('style');
        animationStyle.textContent = `
            @keyframes fadeInOut {
                0% { opacity: 0; transform: translateY(10px); }
                10%, 90% { opacity: 1; transform: translateY(0); }
                100% { opacity: 0; transform: translateY(-10px); }
            }
            
            /* é«˜äº®å…ƒç´ çš„æ ·å¼å¢å¼º */
            .highlighted-element {
                animation: pulseHighlight 1.5s infinite ease-in-out !important;
                outline: 2px solid #3498db !important;
                outline-offset: 3px !important;
                box-shadow: 0 0 15px rgba(52, 152, 219, 0.5) !important;
            }
            
            @keyframes pulseHighlight {
                0%, 100% { outline-color: #3498db; box-shadow: 0 0 15px rgba(52, 152, 219, 0.5); }
                50% { outline-color: #2980b9; box-shadow: 0 0 25px rgba(52, 152, 219, 0.8); }
            }
        `;
        document.head.appendChild(animationStyle);
        
        // æ·»åŠ é˜²æŠ–å˜é‡
        let filterTimeout;
        
        function filterComponents(searchTerm) {
            // é˜²æŠ–å¤„ç†
            if (filterTimeout) {
                clearTimeout(filterTimeout);
            }
            
            filterTimeout = setTimeout(() => {
                const componentItems = document.querySelectorAll('.component-item');
                const componentGroups = document.querySelectorAll('.component-group');
                let visibleCount = 0;
                
                searchTerm = searchTerm.toLowerCase().trim();
                
                // è·å–è¿‡æ»¤å™¨å€¼
                const typeFilter = document.getElementById('type-filter')?.value || 'all';
                const stateFilter = document.getElementById('state-filter')?.value || 'all';
                
                // ç§»é™¤ä¹‹å‰çš„é«˜äº®å’Œæ¢å¤æ˜¾ç¤ºçŠ¶æ€
                componentItems.forEach(item => {
                    const titleEl = item.querySelector('.component-title');
                    if (titleEl) {
                        titleEl.innerHTML = titleEl.textContent;
                    }
                    
                    const infoValues = item.querySelectorAll('.info-value');
                    infoValues.forEach(el => {
                        el.innerHTML = el.textContent;
                    });
                    
                    item.style.display = 'block';
                });
                
                componentGroups.forEach(group => {
                    group.style.display = 'block';
                });
                
                // ç§»é™¤ä¹‹å‰çš„æ— ç»“æœæç¤º
                const oldNoResults = document.querySelector('.no-results');
                if (oldNoResults) {
                    oldNoResults.remove();
                }
                
                // åº”ç”¨è¿‡æ»¤æ¡ä»¶
                componentItems.forEach(item => {
                    let matchesSearch = true;
                    let matchesType = true;
                    let matchesState = true;
                    
                    // æœç´¢è¿‡æ»¤
                    if (searchTerm) {
                        const text = item.textContent.toLowerCase();
                        matchesSearch = text.includes(searchTerm.toLowerCase());
                    }
                    
                    // ç±»å‹è¿‡æ»¤
                    if (typeFilter !== 'all') {
                        const typeValue = item.querySelector('.info-row:contains("ç±»å‹") .info-value');
                        matchesType = typeValue && typeValue.textContent.toLowerCase() === typeFilter;
                    }
                    
                    // çŠ¶æ€è¿‡æ»¤
                    if (stateFilter !== 'all') {
                        const indicator = item.querySelector('.component-indicator');
                        const status = indicator ? indicator.getAttribute('data-status') : 'unknown';
                        matchesState = status === stateFilter;
                    }
                    
                    // ç»¼åˆåˆ¤æ–­
                    const matches = matchesSearch && matchesType && matchesState;
                    item.style.display = matches ? 'block' : 'none';
                    if (matches) visibleCount++;
                    
                    // é«˜äº®åŒ¹é…æ–‡æœ¬
                    if (matches && searchTerm) {
                        highlightText(item, searchTerm);
                    }
                });
                
                // å¤„ç†ç»„ä»¶ç»„æ˜¾ç¤º
                componentGroups.forEach(group => {
                    const visibleItems = group.querySelectorAll('.component-item[style="display: block;"]');
                    const hasVisibleItems = visibleItems.length > 0;
                    
                    group.style.display = hasVisibleItems ? 'block' : 'none';
                });
                
                // å¦‚æœæ²¡æœ‰æœç´¢è¯ä¸”è¿‡æ»¤å™¨éƒ½ä¸ºallï¼Œåˆ™æ˜¾ç¤ºæ‰€æœ‰ç»„ä»¶
                if (searchTerm === '' && typeFilter === 'all' && stateFilter === 'all') {
                    return;
                }
                
                // è¿‡æ»¤ç»„ä»¶
                componentItems.forEach(item => {
                    const title = item.querySelector('.component-title').textContent.toLowerCase();
                    const titleEl = item.querySelector('.component-title');
                    const infoValues = Array.from(item.querySelectorAll('.info-value'));
                    
                    // æ£€æŸ¥æ›´å¤šå­—æ®µ
                    const allText = [
                        title,
                        ...infoValues.map(el => el.textContent.toLowerCase()),
                        item.getAttribute('data-component-id')?.toLowerCase() || ''
                    ].join(' ');
                    
                    const matches = allText.includes(searchTerm);
                    
                    if (matches) {
                        item.style.display = 'block';
                        visibleCount++;
                        
                        // é«˜äº®æ ‡é¢˜
                        if (titleEl) {
                            titleEl.innerHTML = highlightText(titleEl.textContent, searchTerm);
                        }
                        
                        // é«˜äº®ä¿¡æ¯å€¼
                        infoValues.forEach(el => {
                            if (el.textContent.toLowerCase().includes(searchTerm)) {
                                el.innerHTML = highlightText(el.textContent, searchTerm);
                            }
                        });
                    } else {
                        item.style.display = 'none';
                    }
                });
                
                // å¤„ç†ç»„ä»¶ç»„æ˜¾ç¤º
                componentGroups.forEach(group => {
                    const visibleItems = Array.from(group.querySelectorAll('.component-item'))
                        .filter(item => item.style.display !== 'none');
                    
                    if (visibleItems.length === 0 && searchTerm !== '') {
                        group.style.display = 'none';
                    } else {
                        group.style.display = 'block';
                    }
                });
                
                // æ˜¾ç¤ºæ— ç»“æœæç¤º
                if (visibleCount === 0 && searchTerm !== '') {
                    const noResultsEl = document.createElement('div');
                    noResultsEl.className = 'no-results';
                    noResultsEl.innerHTML = `
                        <div style="font-size: 24px; margin-bottom: 10px;">ğŸ”</div>
                        <div style="font-weight: 500; margin-bottom: 5px;">æœªæ‰¾åˆ°åŒ¹é…çš„ç»„ä»¶</div>
                        <div style="font-size: 13px; color: #666;">
                            æœç´¢è¯: "${searchTerm}"
                        </div>
                        <div style="font-size: 12px; color: #999; margin-top: 10px;">
                            å°è¯•ä½¿ç”¨å…¶ä»–å…³é”®è¯æˆ–æ¸…ç©ºæœç´¢æ¡†
                        </div>
                    `;
                    componentsContainer.appendChild(noResultsEl);
                    
                    // è®°å½•æœç´¢å¤±è´¥
                    console.log(`æœç´¢å¤±è´¥: æœªæ‰¾åˆ°åŒ¹é…"${searchTerm}"çš„ç»„ä»¶`);
                }
            }, 250); // 250ms é˜²æŠ–å»¶è¿Ÿ
        }
        
        function highlightText(text, searchTerm) {
            if (!searchTerm || !text) return text;
            
            try {
                // è½¬ä¹‰æ­£åˆ™ç‰¹æ®Šå­—ç¬¦
                const escapedTerm = searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const regex = new RegExp(`(${escapedTerm})`, 'gi');
                return text.replace(regex, '<mark>$1</mark>');
            } catch (e) {
                console.error('æœç´¢é«˜äº®é”™è¯¯:', e);
                return text;
            }
        }
        
        // å®ç°ç®€å•çš„æœ¬åœ°äº‹ä»¶é”æœºåˆ¶
        let localEventLock = false;
        const LOCK_DURATION = 50; // å‡å°é”å®šæ—¶é—´ï¼Œæ”¯æŒæ›´å¿«çš„ç‚¹å‡»é€Ÿåº¦
        
        function tryLocalLock() {
            if (localEventLock) {
                console.warn('âš ï¸ [shortcut] æ“ä½œé”å®šä¸­ï¼Œé˜»æ­¢é‡å¤è§¦å‘');
                return false;
            }
            
            localEventLock = true;
            setTimeout(() => {
                localEventLock = false;
            }, LOCK_DURATION);
            
            return true;
        }
        
        // æ·»åŠ é˜²æŠ–æ ‡å¿—å’Œæ—¶é—´æˆ³ï¼Œç”¨äºæ§åˆ¶å¿«æ·é”®
        let lastToggleTime = 0;
        const DEBOUNCE_TIME = 300; // é˜²æŠ–æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
        
        // é¦–å…ˆè·å–æ‰€æœ‰æŒ‰é’®å…ƒç´ 
        const resetButton = document.getElementById('reset-btn');
        const tapButton = document.getElementById('tap-btn');
        
        // ä¸ºwindowå¯¹è±¡æ·»åŠ é”®ç›˜äº‹ä»¶ç›‘å¬å™¨ï¼Œå®ç°å¿«æ·é”®æ§åˆ¶
        // ä½¿ç”¨keydownäº‹ä»¶ä»£æ›¿keyupï¼Œç¡®ä¿å³ä½¿ä¸‹æ‹‰èœå•è·å¾—ç„¦ç‚¹ä¹Ÿèƒ½æ•è·äº‹ä»¶
        window.addEventListener('keydown', function(event) {
            // æ£€æŸ¥æ˜¯å¦æŒ‰ä¸‹çš„æ˜¯ç©ºæ ¼é”® - ç”¨äºæ§åˆ¶èŠ‚æ‹å™¨çš„å¼€å§‹/åœæ­¢
            if (event.code === 'Space') {
                // é˜»æ­¢ç©ºæ ¼é”®çš„é»˜è®¤è¡Œä¸ºï¼ˆæ»šåŠ¨é¡µé¢æˆ–åœ¨ä¸‹æ‹‰èœå•ä¸­é€‰æ‹©ï¼‰
                event.preventDefault();
                event.stopPropagation();
                
                // å¿½ç•¥é•¿æŒ‰é‡å¤è§¦å‘
                if (event.repeat) {
                    console.log('ğŸ”„ [space-shortcut] å¿½ç•¥é‡å¤äº‹ä»¶');
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦æ²¡æœ‰åŒæ—¶æŒ‰ä¸‹å…¶ä»–ä¿®é¥°é”®ï¼ˆå¦‚Shiftã€Ctrlç­‰ï¼‰
                // è¿™æ ·å¯ä»¥é¿å…ä¸æµè§ˆå™¨æˆ–ç³»ç»Ÿå¿«æ·é”®å†²çª
                if (!event.shiftKey && !event.ctrlKey && !event.altKey && !event.metaKey) {
                    // ğŸ”¥ ä½¿ç”¨æœ¬åœ°äº‹ä»¶é”é˜²æ­¢é‡å¤è§¦å‘
                    if (!tryLocalLock()) {
                        return;
                    }
                    
                    // è§¦å‘å¼€å§‹/åœæ­¢æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
                    if (toggleButton) {
                        toggleButton.click();
                    }
                    
                    // è¾“å‡ºè°ƒè¯•ä¿¡æ¯åˆ°æ§åˆ¶å°
                    console.log('âœ… [space-shortcut] æ‰§è¡ŒèŠ‚æ‹å™¨åˆ‡æ¢');
                }
            }
            // æ£€æŸ¥æ˜¯å¦æŒ‰ä¸‹çš„æ˜¯Ré”®ï¼ˆç”¨äºå¤ä½èŠ‚æ‹å™¨ï¼‰
            else if (event.code === 'KeyR' && !event.shiftKey && !event.ctrlKey && !event.altKey && !event.metaKey) {
                // é˜»æ­¢é»˜è®¤è¡Œä¸º
                event.preventDefault();
                
                // è§¦å‘å¤ä½æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶ï¼Œæ¢å¤æ‰€æœ‰é»˜è®¤è®¾ç½®
                if (resetButton) {
                    resetButton.click();
                }
                
                console.log('Ré”®è¢«æŒ‰ä¸‹ï¼Œæ‰§è¡Œå¤ä½æ“ä½œ');
            }
            // æ£€æŸ¥æ˜¯å¦æŒ‰ä¸‹çš„æ˜¯Té”®ï¼ˆç”¨äºTAPæµ‹é€Ÿï¼‰
            else if (event.code === 'KeyT' && !event.shiftKey && !event.ctrlKey && !event.altKey && !event.metaKey) {
                // é˜»æ­¢é»˜è®¤è¡Œä¸º
                event.preventDefault();
                
                // å¿½ç•¥é•¿æŒ‰é‡å¤è§¦å‘
                if (event.repeat) {
                    console.log('ğŸ”„ [tap-shortcut] å¿½ç•¥é‡å¤äº‹ä»¶');
                    return;
                }
                
                // ä½¿ç”¨æœ¬åœ°äº‹ä»¶é”é˜²æ­¢é‡å¤è§¦å‘
                if (!tryLocalLock()) {
                    return;
                }
                
                // è§¦å‘TAPæŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
                if (tapButton) {
                    tapButton.click();
                }
                
                console.log('âœ… [tap-shortcut] Té”®è¢«æŒ‰ä¸‹ï¼Œæ‰§è¡ŒTAPæµ‹é€Ÿæ“ä½œ');
            }
        });
        
        // ä¸ºæŒ‰é’®æ·»åŠ ARIAå±æ€§ï¼Œæé«˜å¯è®¿é—®æ€§
        // ä¸ºå¼€å§‹/åœæ­¢æŒ‰é’®è®¾ç½®é”®ç›˜å¿«æ·é”®æç¤º
        if (toggleButton) {
            toggleButton.setAttribute('aria-keyshortcuts', ' ');
            toggleButton.setAttribute('title', 'å¼€å§‹/åœæ­¢ (ç©ºæ ¼é”®)');
        }
        
        // ä¸ºå¤ä½æŒ‰é’®è®¾ç½®é”®ç›˜å¿«æ·é”®æç¤º
        if (resetButton) {
            resetButton.setAttribute('aria-keyshortcuts', 'R');
            resetButton.setAttribute('title', 'å¤ä½ (Ré”®)');
        }
        
        // ä¸ºTAPæŒ‰é’®è®¾ç½®é”®ç›˜å¿«æ·é”®æç¤º
        if (tapButton) {
            tapButton.setAttribute('aria-keyshortcuts', 'T');
            tapButton.setAttribute('title', 'TAPæµ‹é€Ÿ (Té”®)');
        }
        
        // è®­ç»ƒæ¨¡å¼ç›¸å…³ä»£ç 
        // è®­ç»ƒæ¨¡å¼çŠ¶æ€å˜é‡
        let isTrainingMode = false;
        let trainingConfig = {
            initialBpm: 60,
            targetBpm: 120,
            barsPerChange: 4,
            bpmChangeStep: 3,
            currentBpm: 60,
            barsCompleted: 0,
            isIncreasing: true
        };
        
        // è·å–DOMå…ƒç´ 
        const trainingBtn = document.getElementById('training-btn');
        const trainingModal = document.getElementById('training-modal');
        const closeModal = document.querySelector('.close-modal');
        const initialBpmInput = document.getElementById('initial-bpm');
        const targetBpmInput = document.getElementById('target-bpm');
        const barsPerChangeInput = document.getElementById('bars-per-change');
        const bpmChangeStepInput = document.getElementById('bpm-change-step');
        const baseBpmInput = document.getElementById('base-bpm');
        const randomRangeInput = document.getElementById('random-range');
        const randomChangeIntervalInput = document.getElementById('random-change-interval');
        const rhythmBaseBpmInput = document.getElementById('rhythm-base-bpm');
        const muteProbabilityInput = document.getElementById('mute-probability');
        // ç§»é™¤äº†èŠ‚å¥æ§åˆ¶çš„æ¯å°èŠ‚æ‹æ•°è¾“å…¥
        const toggleTrainingBtn = document.getElementById('toggle-training-btn');
        const trainingStatusText = document.getElementById('training-status-text');
        const trainingBpmValue = document.getElementById('training-bpm-value');
        const barsCompletedElement = document.getElementById('bars-completed');
        const barsUntilChangeElement = document.getElementById('bars-until-change');
        
        // åˆ†æ®µè®­ç»ƒç›¸å…³DOMå…ƒç´ 
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        const segmentsCountInput = document.getElementById('segments-count');
        const segmentsContainer = document.getElementById('segments-container');
        const loopSegmentsCheckbox = document.getElementById('loop-segments');
        const segmentInfo = document.getElementById('segment-info');
        const currentSegmentElement = document.getElementById('current-segment');
        const totalSegmentsElement = document.getElementById('total-segments');
        
        // æ ‡ç­¾åˆ‡æ¢é€»è¾‘
        if (tabBtns.length > 0) {
            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const tab = btn.getAttribute('data-tab');
                    
                    // æ›´æ–°æ ‡ç­¾æŒ‰é’®çŠ¶æ€
                    tabBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    // æ›´æ–°æ ‡ç­¾å†…å®¹æ˜¾ç¤º
                    tabContents.forEach(content => content.classList.remove('active'));
                    const activeContent = document.getElementById(`${tab}-tab`);
                    if (activeContent) activeContent.classList.add('active');
                });
            });
        }
        
        // åˆå§‹åŒ–è®­ç»ƒæ¨¡å¼ç±»å‹
        let trainingModeType = 'progressive'; // 'progressive' æˆ– 'segmented'
        
        // æ¨¡æ€çª—å£æ§åˆ¶
        if (trainingBtn && trainingModal) {
            trainingBtn.addEventListener('click', () => {
                trainingModal.style.display = 'block';
            });
        }
        
        if (closeModal && trainingModal) {
            closeModal.addEventListener('click', () => {
                trainingModal.style.display = 'none';
            });
        }
        
        // ç‚¹å‡»æ¨¡æ€çª—å£å¤–éƒ¨å…³é—­
        if (trainingModal) {
            trainingModal.addEventListener('click', (e) => {
                if (e.target === trainingModal) {
                    trainingModal.style.display = 'none';
                }
            });
        }
        
        // ç”Ÿæˆåˆ†æ®µè®¾ç½®UI
        function generateSegmentsUI(count) {
            if (!segmentsContainer || !segmentsCountInput) return;
            
            // ç¡®ä¿åˆ†æ®µæ•°é‡åœ¨æœ‰æ•ˆèŒƒå›´å†…ï¼ˆè‡³å°‘2ä¸ªï¼Œæœ€å¤š8ä¸ªï¼‰
            const validCount = Math.max(2, Math.min(8, count));
            
            // æ›´æ–°è¾“å…¥æ¡†å€¼
            segmentsCountInput.value = validCount;
            
            // æ¸…ç©ºå®¹å™¨
            segmentsContainer.innerHTML = '';
            
            // é»˜è®¤åˆ†æ®µé…ç½®
            const defaultSegments = [
                { bpm: 60, beatsPerBar: 4, bars: 4 },
                { bpm: 80, beatsPerBar: 4, bars: 4 },
                { bpm: 100, beatsPerBar: 4, bars: 4 },
                { bpm: 120, beatsPerBar: 4, bars: 4 },
                { bpm: 140, beatsPerBar: 4, bars: 4 },
                { bpm: 160, beatsPerBar: 4, bars: 4 },
                { bpm: 180, beatsPerBar: 4, bars: 4 },
                { bpm: 200, beatsPerBar: 4, bars: 4 }
            ];
            
            // ç”Ÿæˆæ¯ä¸ªåˆ†æ®µ
            for (let i = 0; i < validCount; i++) {
                const segmentConfig = defaultSegments[i] || defaultSegments[0];
                const segmentDiv = document.createElement('div');
                segmentDiv.className = 'segment-config';
                segmentDiv.style.marginBottom = '20px';
                segmentDiv.style.padding = '15px';
                segmentDiv.style.border = '1px solid #ccc';
                segmentDiv.style.borderRadius = '5px';
                
                // å…³é”®é€»è¾‘ï¼šåªæœ‰å½“åˆ†æ®µæ•°é‡å¤§äºç­‰äº3æ—¶ï¼Œæ‰æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
                const showDeleteButton = validCount >= 3;
                
                // åˆ›å»ºåˆ†æ®µHTMLå†…å®¹
                let headerHtml = '';
                if (showDeleteButton) {
                    // æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
                    headerHtml = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h4 style="margin: 0;">åˆ†æ®µ ${i + 1}</h4>
                            <button class="remove-segment-btn" style="background: #ff4444; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">
                                åˆ é™¤
                            </button>
                        </div>
                    `;
                } else {
                    // ä¸æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
                    headerHtml = `
                        <h4 style="margin-top: 0;">åˆ†æ®µ ${i + 1}</h4>
                    `;
                }
                
                segmentDiv.innerHTML = headerHtml + `
                    <div class="training-control-group">
                        <label>BPM:</label>
                        <input type="number" class="segment-bpm" min="20" max="300" value="${segmentConfig.bpm}">
                    </div>
                    <div class="training-control-group">
                        <label>æ‹æ•°/å°èŠ‚:</label>
                        <input type="number" class="segment-beats" min="1" max="16" value="${segmentConfig.beatsPerBar}">
                    </div>
                    <div class="training-control-group">
                        <label>å°èŠ‚æ•°:</label>
                        <input type="number" class="segment-bars" min="1" max="32" value="${segmentConfig.bars}">
                    </div>
                `;
                
                // æ·»åŠ åˆ°å®¹å™¨
                segmentsContainer.appendChild(segmentDiv);
                
                // å¦‚æœæ˜¾ç¤ºåˆ é™¤æŒ‰é’®ï¼Œæ·»åŠ ç‚¹å‡»äº‹ä»¶
                if (showDeleteButton) {
                    const deleteBtn = segmentDiv.querySelector('.remove-segment-btn');
                    if (deleteBtn) {
                        deleteBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            // ç¡®ä¿åˆ é™¤åè‡³å°‘ä¿ç•™2ä¸ªåˆ†æ®µ
                            const newCount = validCount - 1;
                            if (newCount >= 2) {
                                generateSegmentsUI(newCount);
                            }
                        });
                    }
                }
            }
        }
        
        // åˆå§‹åŒ–åˆ†æ®µè®­ç»ƒUI
        if (segmentsCountInput && segmentsContainer) {
            // è®¾ç½®è¾“å…¥æ¡†å±æ€§
            segmentsCountInput.min = 2;
            segmentsCountInput.max = 8;
            segmentsCountInput.value = 2;
            
            // æ·»åŠ å˜åŒ–äº‹ä»¶ç›‘å¬
            segmentsCountInput.addEventListener('change', () => {
                const count = parseInt(segmentsCountInput.value) || 2;
                generateSegmentsUI(count);
            });
            
            // åˆå§‹ç”Ÿæˆ2ä¸ªåˆ†æ®µï¼ˆä¸å¸¦åˆ é™¤æŒ‰é’®ï¼‰
            generateSegmentsUI(2);
        }
        
        // åˆå§‹åŒ–è®­ç»ƒé…ç½®
        function initializeTrainingConfig() {
            // é‡ç½®åŸºæœ¬é…ç½®
            trainingConfig.currentBpm = 60;
            trainingConfig.barsCompleted = 0;
            trainingConfig.nextBpm = undefined;
            trainingConfig.shouldStopAfterNextChange = false;
            
            // æ ¹æ®å½“å‰æ¿€æ´»çš„æ ‡ç­¾ç¡®å®šè®­ç»ƒæ¨¡å¼ç±»å‹
            const activeTab = document.querySelector('.tab-btn.active');
            if (activeTab) {
                trainingModeType = activeTab.getAttribute('data-tab');
            }
            
            if (trainingModeType === 'progressive') {
                // å˜é€Ÿæ¨¡å¼é…ç½®
                trainingConfig.initialBpm = parseInt(initialBpmInput?.value || 60);
                trainingConfig.targetBpm = parseInt(targetBpmInput?.value || 120);
                trainingConfig.barsPerChange = parseInt(barsPerChangeInput?.value || 4);
                trainingConfig.bpmChangeStep = parseInt(bpmChangeStepInput?.value || 3);
                trainingConfig.currentBpm = trainingConfig.initialBpm;
                trainingConfig.isIncreasing = trainingConfig.initialBpm < trainingConfig.targetBpm;
            } else if (trainingModeType === 'segmented') {
                // åˆ†æ®µè®­ç»ƒé…ç½®
                trainingConfig.segments = [];
                const segmentConfigs = document.querySelectorAll('.segment-config');
                segmentConfigs.forEach((segment, index) => {
                    const bpm = parseInt(segment.querySelector('.segment-bpm')?.value || 60);
                    const beatsPerBar = parseInt(segment.querySelector('.segment-beats')?.value || 4);
                    const bars = parseInt(segment.querySelector('.segment-bars')?.value || 4);
                    
                    trainingConfig.segments.push({
                        bpm,
                        beatsPerBar,
                        bars,
                        totalBeats: beatsPerBar * bars
                    });
                });
                
                trainingConfig.currentSegmentIndex = 0;
                // å®‰å…¨åœ°è®¾ç½®å½“å‰åˆ†æ®µï¼Œé˜²æ­¢ç©ºæ•°ç»„å¯¼è‡´çš„é”™è¯¯
                if (trainingConfig.segments.length > 0) {
                    trainingConfig.currentSegment = trainingConfig.segments[0];
                    trainingConfig.currentBpm = trainingConfig.currentSegment.bpm;
                } else {
                    // å¦‚æœæ²¡æœ‰åˆ†æ®µï¼Œä½¿ç”¨é»˜è®¤å€¼
                    trainingConfig.currentSegment = { bpm: 60, beatsPerBar: 4, bars: 4, totalBeats: 16 };
                    trainingConfig.currentBpm = 60;
                }
                trainingConfig.loopSegments = loopSegmentsCheckbox?.checked || false;
                trainingConfig.segmentBarsCompleted = 0;
            } else if (trainingModeType === 'random') {
                // éšæœºå˜é€Ÿæ¨¡å¼é…ç½®
                trainingConfig.baseBpm = parseInt(baseBpmInput?.value || 120);
                trainingConfig.randomRange = parseInt(randomRangeInput?.value || 10);
                trainingConfig.randomChangeInterval = parseInt(randomChangeIntervalInput?.value || 4);
                trainingConfig.currentBpm = trainingConfig.baseBpm;
                trainingConfig.currentIntervalBars = 0;
                trainingConfig.currentRandomFactor = 1;
            } else if (trainingModeType === 'rhythm') {
                // èŠ‚å¥æ§åˆ¶æ¨¡å¼é…ç½®
                trainingConfig.baseBpm = parseInt(rhythmBaseBpmInput?.value || 120);
                trainingConfig.muteProbability = parseInt(muteProbabilityInput?.value || 50);
                // ç§»é™¤äº†èŠ‚å¥æ§åˆ¶çš„æ¯å°èŠ‚æ‹æ•°é…ç½®
                trainingConfig.currentBpm = trainingConfig.baseBpm;
                trainingConfig.muteCurrentBar = false; // æ ‡è®°å½“å‰å°èŠ‚æ˜¯å¦é™éŸ³
            }
            
            // æ›´æ–°UIæ˜¾ç¤º
            if (trainingBpmValue) trainingBpmValue.textContent = trainingConfig.currentBpm;
            if (barsCompletedElement) barsCompletedElement.textContent = trainingConfig.barsCompleted;
            if (barsUntilChangeElement) {
                barsUntilChangeElement.textContent = trainingModeType === 'progressive' ? 
                    (trainingConfig.barsPerChange || 4) : 
                    (trainingConfig.currentSegment?.bars || 4);
            }
            
            // æ›´æ–°åˆ†æ®µä¿¡æ¯æ˜¾ç¤º
            if (segmentInfo) {
                segmentInfo.style.display = trainingModeType === 'segmented' ? 'block' : 'none';
            }
            if (currentSegmentElement && totalSegmentsElement && trainingModeType === 'segmented') {
                currentSegmentElement.textContent = '1';
                totalSegmentsElement.textContent = trainingConfig.segments.length;
            }
        }
        
        // æ›´æ–°è®­ç»ƒçŠ¶æ€æ˜¾ç¤º
        function updateTrainingStatus() {
            if (trainingBpmValue) trainingBpmValue.textContent = trainingConfig.currentBpm;
            if (barsCompletedElement) barsCompletedElement.textContent = trainingModeType === 'segmented' ? 
                (trainingConfig.segmentBarsCompleted || 0) : (trainingConfig.currentIntervalBars || trainingConfig.barsCompleted || 0);
            if (barsUntilChangeElement) {
                if (trainingModeType === 'progressive') {
                    barsUntilChangeElement.textContent = trainingConfig.barsPerChange || 4;
                } else if (trainingModeType === 'random') {
                    barsUntilChangeElement.textContent = (trainingConfig.randomChangeInterval || 4) - (trainingConfig.currentIntervalBars || 0);
                } else {
                    barsUntilChangeElement.textContent = trainingConfig.currentSegment?.bars || 4;
                }
            }
            
            // æ›´æ–°è®­ç»ƒçŠ¶æ€æ–‡æœ¬
            if (trainingStatusText) {
                if (isTrainingMode) {
                    if (trainingModeType === 'random') {
                        const changePercent = trainingConfig.currentRandomFactor ? Math.round((trainingConfig.currentRandomFactor - 1) * 100) : 0;
                        trainingStatusText.textContent = `éšæœºå˜é€Ÿæ¨¡å¼ - åŸºç¡€BPM: ${trainingConfig.baseBpm}, å½“å‰å˜åŒ–: ${changePercent > 0 ? '+' : ''}${changePercent}%`;
                        trainingStatusText.style.color = '#e67e22'; // æ©™è‰²
                    } else if (trainingModeType === 'rhythm') {
                        trainingStatusText.textContent = `èŠ‚å¥æ§åˆ¶ - åŸºç¡€BPM: ${trainingConfig.baseBpm}, é™éŸ³æ¦‚ç‡: ${trainingConfig.muteProbability}%`;
                        trainingStatusText.style.color = '#9b59b6'; // ç´«è‰²
                    } else if (trainingModeType === 'segmented') {
                        trainingStatusText.textContent = `åˆ†æ®µè®­ç»ƒä¸­ - åˆ†æ®µ ${(trainingConfig.currentSegmentIndex || 0) + 1}/${(trainingConfig.segments || []).length}`;
                        trainingStatusText.style.color = '#3498db'; // è“è‰²
                    } else {
                        trainingStatusText.textContent = `å˜é€Ÿæ¨¡å¼ - ${trainingConfig.isIncreasing ? 'åŠ é€Ÿ' : 'å‡é€Ÿ'}è®­ç»ƒ`;
                        trainingStatusText.style.color = '#2ecc71'; // ç»¿è‰²
                    }
                } else {
                    trainingStatusText.textContent = 'å°±ç»ª';
                    trainingStatusText.style.color = '#27ae60'; // ç»¿è‰²
                }
            }
            
            // æ›´æ–°åˆ†æ®µä¿¡æ¯
            if (segmentInfo) {
                segmentInfo.style.display = trainingModeType === 'segmented' ? 'block' : 'none';
            }
            if (currentSegmentElement && totalSegmentsElement && trainingModeType === 'segmented') {
                currentSegmentElement.textContent = (trainingConfig.currentSegmentIndex || 0) + 1;
                totalSegmentsElement.textContent = (trainingConfig.segments || []).length;
            }
        }
        
        // åˆ†æ®µè®­ç»ƒçš„å°èŠ‚å®Œæˆå¤„ç†
        function handleSegmentBarComplete() {
            trainingConfig.segmentBarsCompleted = (trainingConfig.segmentBarsCompleted || 0) + 1;
            
            log(`åˆ†æ®µ ${trainingConfig.currentSegmentIndex + 1} å®Œæˆå°èŠ‚: ${trainingConfig.segmentBarsCompleted}/${trainingConfig.currentSegment.bars}`);
            
            // æ£€æŸ¥å½“å‰åˆ†æ®µæ˜¯å¦å®Œæˆ
            if (trainingConfig.segmentBarsCompleted >= trainingConfig.currentSegment.bars) {
                // ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªåˆ†æ®µ
                trainingConfig.currentSegmentIndex++;
                
                // æ£€æŸ¥æ˜¯å¦å®Œæˆæ‰€æœ‰åˆ†æ®µ
                if (trainingConfig.currentSegmentIndex >= trainingConfig.segments.length) {
                    if (trainingConfig.loopSegments) {
                        // å¾ªç¯æ’­æ”¾ï¼Œå›åˆ°ç¬¬ä¸€ä¸ªåˆ†æ®µ
                        trainingConfig.currentSegmentIndex = 0;
                        log('å¾ªç¯æ’­æ”¾: å›åˆ°ç¬¬ä¸€ä¸ªåˆ†æ®µ');
                    } else {
                        // åœæ­¢è®­ç»ƒ
                        isTrainingMode = false;
                        if (trainingStatusText) {
                            trainingStatusText.textContent = 'å·²å®Œæˆæ‰€æœ‰åˆ†æ®µ';
                            trainingStatusText.style.color = '#27ae60';
                        }
                        if (toggleTrainingBtn) {
                            toggleTrainingBtn.textContent = 'å¼€å§‹è®­ç»ƒ';
                            toggleTrainingBtn.classList.add('start');
                            toggleTrainingBtn.classList.remove('stop');
                        }
                        log('è®­ç»ƒå®Œæˆ: å·²å®Œæˆæ‰€æœ‰åˆ†æ®µ');
                        return;
                    }
                }
                
                // æ›´æ–°å½“å‰åˆ†æ®µ
                trainingConfig.currentSegment = trainingConfig.segments[trainingConfig.currentSegmentIndex];
                trainingConfig.segmentBarsCompleted = 0;
                
                // è®¾ç½®ä¸‹ä¸€å°èŠ‚çš„BPMï¼ˆå°†åœ¨ä¸‹ä¸€å°èŠ‚ç¬¬ä¸€æ‹æ—¶åº”ç”¨ï¼‰
                trainingConfig.nextBpm = trainingConfig.currentSegment.bpm;
                
                // å¦‚æœæ‹æ•°å‘ç”Ÿå˜åŒ–ï¼Œéœ€è¦åœ¨ä¸‹ä¸€å°èŠ‚å¼€å§‹æ—¶æ›´æ–°
                if (currentNumerator !== trainingConfig.currentSegment.beatsPerBar) {
                    trainingConfig.nextBeatsPerBar = trainingConfig.currentSegment.beatsPerBar;
                }
                
                log(`å‡†å¤‡åˆ‡æ¢åˆ°åˆ†æ®µ ${trainingConfig.currentSegmentIndex + 1}ï¼ŒBPM: ${trainingConfig.currentSegment.bpm}ï¼Œæ‹æ•°: ${trainingConfig.currentSegment.beatsPerBar}`);
            }
            
            updateTrainingStatus();
        }
        
        // éªŒè¯åˆ†æ®µè®­ç»ƒè¾“å…¥
        function validateSegmentTraining() {
            const segmentsCount = parseInt(segmentsCountInput?.value) || 0;
            if (segmentsCount < 2 || segmentsCount > 8) {
                alert('åˆ†æ®µæ•°é‡å¿…é¡»åœ¨2-8ä¹‹é—´');
                return false;
            }
            
            // ä½¿ç”¨ç¡¬ç¼–ç çš„å€¼ï¼Œä¸é…ç½®æ–‡ä»¶ä¿æŒä¸€è‡´
            const minBPM = 40;
            const maxBPM = 300;
            
            const segmentConfigs = document.querySelectorAll('.segment-config');
            for (let i = 0; i < segmentConfigs.length; i++) {
                const bpm = parseInt(segmentConfigs[i].querySelector('.segment-bpm').value) || 0;
                const beats = parseInt(segmentConfigs[i].querySelector('.segment-beats').value) || 0;
                const bars = parseInt(segmentConfigs[i].querySelector('.segment-bars').value) || 0;
                
                if (bpm < minBPM || bpm > maxBPM) {
                    alert(`åˆ†æ®µ ${i + 1} çš„BPMå€¼å¿…é¡»åœ¨${minBPM}-${maxBPM}ä¹‹é—´`);
                    return false;
                }
                if (beats < 1 || beats > 16) {
                    alert(`åˆ†æ®µ ${i + 1} çš„æ‹æ•°å¿…é¡»åœ¨1-16ä¹‹é—´`);
                    return false;
                }
                if (bars < 1 || bars > 32) {
                    alert(`åˆ†æ®µ ${i + 1} çš„å°èŠ‚æ•°å¿…é¡»åœ¨1-32ä¹‹é—´`);
                    return false;
                }
            }
            
            return true;
        }
        
        // æ•´åˆçš„è®­ç»ƒæ¨¡å¼åˆ‡æ¢æŒ‰é’®
        if (toggleTrainingBtn) {
            toggleTrainingBtn.addEventListener('click', () => {
                if (!isTrainingMode) {
                    // å¼€å§‹è®­ç»ƒé€»è¾‘
                    // è·å–å½“å‰æ¿€æ´»çš„æ ‡ç­¾
                    const activeTab = document.querySelector('.tab-btn.active');
                    if (activeTab) {
                        trainingModeType = activeTab.getAttribute('data-tab');
                    }
                    
                    // æ ¹æ®è®­ç»ƒæ¨¡å¼ç±»å‹è¿›è¡ŒéªŒè¯
                    if (trainingModeType === 'progressive') {
                        // éªŒè¯å˜é€Ÿæ¨¡å¼è¾“å…¥
                        const minBPM = 40;
                        const maxBPM = 300;
                        const initialBpm = parseInt(initialBpmInput?.value || 0);
                        const targetBpm = parseInt(targetBpmInput?.value || 0);
                        const barsPerChange = parseInt(barsPerChangeInput?.value || 0);
                        const bpmChangeStep = parseInt(bpmChangeStepInput?.value || 0);
                        
                        if (initialBpm < minBPM || initialBpm > maxBPM || targetBpm < minBPM || targetBpm > maxBPM) {
                            alert(`BPMå€¼å¿…é¡»åœ¨${minBPM}-${maxBPM}ä¹‹é—´`);
                            return;
                        }
                        
                        if (barsPerChange < 1 || barsPerChange > 16) {
                            alert('å°èŠ‚æ•°å¿…é¡»åœ¨1-16ä¹‹é—´');
                            return;
                        }
                        
                        if (bpmChangeStep < 1 || bpmChangeStep > 10) {
                            alert('å˜åŒ–é‡å¿…é¡»åœ¨1-10ä¹‹é—´');
                            return;
                        }
                        
                        if (initialBpm === targetBpm) {
                            alert('åˆå§‹é€Ÿåº¦å’Œç›®æ ‡é€Ÿåº¦ä¸èƒ½ç›¸åŒ');
                            return;
                        }
                    } else if (trainingModeType === 'segmented') {
                        // éªŒè¯åˆ†æ®µè®­ç»ƒè¾“å…¥
                        if (!validateSegmentTraining()) {
                            return;
                        }
                    } else if (trainingModeType === 'random') {
                        // éªŒè¯éšæœºå˜é€Ÿæ¨¡å¼è¾“å…¥
                        const minBPM = 40;
                        const maxBPM = 300;
                        const baseBpm = parseInt(baseBpmInput?.value || 0);
                        const randomRange = parseInt(randomRangeInput?.value || 0);
                        const randomChangeInterval = parseInt(randomChangeIntervalInput?.value || 0);
                        
                        if (baseBpm < minBPM || baseBpm > maxBPM) {
                            alert(`åŸºç¡€BPMå€¼å¿…é¡»åœ¨${minBPM}-${maxBPM}ä¹‹é—´`);
                            return;
                        }
                        
                        if (randomChangeInterval < 1 || randomChangeInterval > 16) {
                            alert('éšæœºå˜åŒ–é—´éš”å¿…é¡»åœ¨1-16å°èŠ‚ä¹‹é—´');
                            return;
                        }
                    } else if (trainingModeType === 'rhythm') {
                        // éªŒè¯èŠ‚å¥æ§åˆ¶æ¨¡å¼è¾“å…¥
                        const minBPM = 40;
                        const maxBPM = 300;
                        const rhythmBaseBpm = parseInt(rhythmBaseBpmInput?.value || 0);
                        const muteProbability = parseInt(muteProbabilityInput?.value || 0);
                        // ç§»é™¤äº†èŠ‚å¥æ§åˆ¶çš„æ¯å°èŠ‚æ‹æ•°å¼•ç”¨
                        
                        if (rhythmBaseBpm < minBPM || rhythmBaseBpm > maxBPM) {
                            alert(`åŸºç¡€BPMå€¼å¿…é¡»åœ¨${minBPM}-${maxBPM}ä¹‹é—´`);
                            return;
                        }
                        
                        if (muteProbability < 5 || muteProbability > 95) {
                            alert('é™éŸ³æ¦‚ç‡å¿…é¡»åœ¨5%-95%ä¹‹é—´');
                            return;
                        }
                        
                        // ç§»é™¤äº†å¯¹æ¯å°èŠ‚æ‹æ•°çš„éªŒè¯ï¼Œå› ä¸ºå·²ä¸å†ä½¿ç”¨
                    }
                    
                    // åˆå§‹åŒ–è®­ç»ƒé…ç½®
                    initializeTrainingConfig();
                    isTrainingMode = true;
                    
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    toggleTrainingBtn.textContent = 'åœæ­¢è®­ç»ƒ';
                    toggleTrainingBtn.classList.remove('start');
                    toggleTrainingBtn.classList.add('stop');
                    
                    // å…³é—­æ¨¡æ€çª—å£
                    if (trainingModal) trainingModal.style.display = 'none';
                    
                    // è®¾ç½®åˆå§‹BPMå’Œæ‹æ•°
                    if (bpmSliderElement) {
                        bpmSliderElement.value = trainingConfig.currentBpm;
                        updateBPMDisplay(trainingConfig.currentBpm);
                    }
                    
                    // æ›´æ–°æ‹æ•°è®¾ç½®ï¼ˆä»…åœ¨åˆ†æ®µè®­ç»ƒæ¨¡å¼ä¸‹ï¼‰
                    if (trainingModeType === 'segmented' && trainingConfig.currentSegment) {
                        setBeatsPerBar(trainingConfig.currentSegment.beatsPerBar);
                    }
                    
                    // è·å–é¢„å¤‡æ‹è®¾ç½®
                    const countdownBeats = parseInt(document.getElementById('countdown-beats')?.value || 0);
                    
                    // è·å–å½“å‰è®­ç»ƒæ¨¡å¼çš„åˆå§‹BPM
                    let initialBpm = trainingConfig.currentBpm || 60;
                    
                    // å¤„ç†é¢„å¤‡æ‹åŠŸèƒ½
                    if (countdownBeats > 0) {
                        // æ˜¾ç¤ºå…¨å±å€’æ•°è¦†ç›–å±‚
                        const countdownOverlay = document.getElementById('countdown-overlay');
                        const countdownNumber = document.getElementById('countdown-number');
                        if (countdownOverlay && countdownNumber) {
                            countdownOverlay.style.display = 'flex';
                            
                            // è®¡ç®—æ¯æ‹çš„æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
                            const beatDuration = (60 / initialBpm) * 1000;
                            
                            let currentCount = countdownBeats;
                            countdownNumber.textContent = currentCount;
                            
                            // æ’­æ”¾é¢„å¤‡æ‹å£°éŸ³å’Œæ›´æ–°æ˜¾ç¤º
                            function playCountdown() {
                                if (currentCount > 0) {
                                    // æ’­æ”¾é¢„å¤‡æ‹å£°éŸ³ - ä½¿ç”¨èŠ‚æ‹å™¨çš„å¸¸è§„ç‚¹å‡»å£°éŸ³
                                    // æ³¨æ„ï¼šè¿™é‡Œå‡è®¾playSoundå‡½æ•°åœ¨index.htmlä¸­å¯ä»¥è®¿é—®
                                    // å¦‚æœä¸å¯ç”¨ï¼Œå¯ä»¥å°è¯•ä½¿ç”¨ç®€å•çš„éŸ³é¢‘å…ƒç´ æˆ–å…¶ä»–æ–¹å¼
                                    try {
                                        playSound({
                                            type: 'regularBeat',
                                            volume: 0.8 // ä½¿ç”¨80%çš„éŸ³é‡
                                        });
                                    } catch (error) {
                                        // å¦‚æœplaySoundä¸å¯ç”¨ï¼Œå¯ä»¥ä½¿ç”¨ç®€å•çš„æ–¹æ³•æˆ–å¿½ç•¥
                                        console.log('æ’­æ”¾é¢„å¤‡æ‹å£°éŸ³:', currentCount);
                                    }
                                    
                                    // æ›´æ–°æ˜¾ç¤ºçš„æ•°å­—
                                    countdownNumber.textContent = currentCount;
                                    
                                    // å‡å°‘è®¡æ•°
                                    currentCount--;
                                    
                                    // åœ¨ä¸‹ä¸€æ‹ç»§ç»­è®¡æ•°
                                    setTimeout(playCountdown, beatDuration);
                                } else {
                                    // å€’æ•°å®Œæˆï¼Œéšè—è¦†ç›–å±‚å¹¶å¼€å§‹è®­ç»ƒ
                                    countdownOverlay.style.display = 'none';
                                    startTraining();
                                }
                            }
                            
                            // å¼€å§‹å€’æ•°
                            playCountdown();
                        }
                    } else {
                        // ä¸éœ€è¦é¢„å¤‡æ‹ï¼Œç›´æ¥å¼€å§‹è®­ç»ƒ
                        startTraining();
                    }
                    
                    // å®é™…å¼€å§‹è®­ç»ƒçš„å‡½æ•°
                    function startTraining() {
                        // å¦‚æœèŠ‚æ‹å™¨æœªè¿è¡Œï¼Œåˆ™å¯åŠ¨å®ƒ
                        if (!isRunning) {
                            startMetronome();
                        } else {
                            // å¦‚æœå·²ç»åœ¨è¿è¡Œï¼Œé‡ç½®èŠ‚æ‹ä½ç½®
                            currentBeatPosition = 1;
                        }
                    }
                    
                    updateTrainingStatus();
                    
                    // è®°å½•ä¸åŒæ¨¡å¼çš„æ—¥å¿—
                    if (trainingModeType === 'segmented') {
                        log('åˆ†æ®µè®­ç»ƒå¼€å§‹: å…±', trainingConfig.segments.length, 'ä¸ªåˆ†æ®µ', 
                            'å¾ªç¯æ’­æ”¾:', trainingConfig.loopSegments ? 'æ˜¯' : 'å¦');
                    } else {
                        log('è®­ç»ƒå¼€å§‹: åˆå§‹BPM', trainingConfig.initialBpm, 'ç›®æ ‡BPM', 
                            trainingConfig.targetBpm, 'æ¯', trainingConfig.barsPerChange, 
                            'å°èŠ‚å˜åŒ–', trainingConfig.bpmChangeStep, 'BPM');
                    }
                } else {
                    // åœæ­¢è®­ç»ƒé€»è¾‘
                    isTrainingMode = false;
                    
                    // åœæ­¢èŠ‚æ‹å™¨
                    stopMetronome();
                    
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    toggleTrainingBtn.textContent = 'å¼€å§‹è®­ç»ƒ';
                    toggleTrainingBtn.classList.remove('stop');
                    toggleTrainingBtn.classList.add('start');
                    
                    updateTrainingStatus();
                    log('è®­ç»ƒåœæ­¢');
                }
            });
        }
        
        // åœ¨å°èŠ‚å®Œæˆæ—¶è°ƒç”¨çš„å‡½æ•° - ç”¨äºæ£€æµ‹æ˜¯å¦éœ€è¦æ”¹å˜BPM
        function onBarComplete() {
            if (!isTrainingMode) return;
            
            updateTrainingStatus();
            
            if (trainingModeType === 'rhythm') {
                // èŠ‚å¥æ§åˆ¶æ¨¡å¼çš„é€»è¾‘ - å†³å®šä¸‹ä¸€å°èŠ‚æ˜¯å¦é™éŸ³
                const randomValue = Math.random() * 100;
                trainingConfig.muteCurrentBar = randomValue < trainingConfig.muteProbability;
                
                if (trainingConfig.muteCurrentBar) {
                    log('ä¸‹ä¸€å°èŠ‚å°†é™éŸ³');
                }
            } else if (trainingModeType === 'random') {
                // éšæœºå˜é€Ÿæ¨¡å¼çš„é€»è¾‘
                trainingConfig.currentIntervalBars = (trainingConfig.currentIntervalBars || 0) + 1;
                
                // æ£€æŸ¥æ˜¯å¦éœ€è¦åœ¨éšæœºå°èŠ‚ä¸­å˜åŒ–BPM
                if (trainingConfig.currentIntervalBars >= trainingConfig.randomChangeInterval) {
                    // ç”Ÿæˆéšæœºå˜åŒ–å› å­ï¼ˆÂ±randomRange%ï¼‰
                    const randomFactor = 1 + (Math.random() - 0.5) * 2 * (trainingConfig.randomRange / 100);
                    trainingConfig.currentRandomFactor = randomFactor;
                    
                    // è®¡ç®—æ–°çš„BPMå€¼å¹¶å››èˆäº”å…¥åˆ°æ•´æ•°
                    const newBpm = Math.round(trainingConfig.baseBpm * randomFactor);
                    
                    // ç¡®ä¿BPMåœ¨æœ‰æ•ˆèŒƒå›´å†…
                    const minBpm = 40;
                    const maxBpm = 300;
                    const clampedBpm = Math.max(minBpm, Math.min(maxBpm, newBpm));
                    
                    // è®¾ç½®æ–°çš„BPM
                    if (clampedBpm !== trainingConfig.currentBpm) {
                        trainingConfig.nextBpm = clampedBpm;
                        log('ä¸‹ä¸€å°èŠ‚å°†ä½¿ç”¨éšæœºBPM:', clampedBpm, '(' + Math.round((randomFactor - 1) * 100) + '%)');
                    }
                    
                    // é‡ç½®é—´éš”è®¡æ•°
                    trainingConfig.currentIntervalBars = 0;
                }
            } else if (trainingModeType === 'progressive') {
                // å˜é€Ÿæ¨¡å¼çš„é€»è¾‘
                trainingConfig.barsCompleted++;
                
                // æ£€æŸ¥æ˜¯å¦éœ€è¦æ”¹å˜BPM
                if (trainingConfig.barsCompleted >= trainingConfig.barsPerChange) {
                    let newBpm = trainingConfig.currentBpm;
                    let shouldStop = false;
                    
                    if (trainingConfig.isIncreasing) {
                        newBpm += trainingConfig.bpmChangeStep;
                        // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°æˆ–è¶…è¿‡ç›®æ ‡é€Ÿåº¦
                        if (newBpm >= trainingConfig.targetBpm) {
                            newBpm = trainingConfig.targetBpm;
                            shouldStop = true; // æ ‡è®°åº”è¯¥åœæ­¢ï¼Œä½†å…ˆæ’­æ”¾ç›®æ ‡é€Ÿåº¦
                        }
                    } else {
                        newBpm -= trainingConfig.bpmChangeStep;
                        // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°æˆ–ä½äºç›®æ ‡é€Ÿåº¦
                        if (newBpm <= trainingConfig.targetBpm) {
                            newBpm = trainingConfig.targetBpm;
                            shouldStop = true; // æ ‡è®°åº”è¯¥åœæ­¢ï¼Œä½†å…ˆæ’­æ”¾ç›®æ ‡é€Ÿåº¦
                        }
                    }
                    
                    // è®¾ç½®ä¸‹ä¸€å°èŠ‚å°†ä½¿ç”¨çš„æ–°BPM
                    if (newBpm !== trainingConfig.currentBpm) {
                        trainingConfig.nextBpm = newBpm;
                        log('ä¸‹ä¸€å°èŠ‚å°†ä½¿ç”¨æ–°BPM:', newBpm);
                        
                        // å¦‚æœè¿™æ˜¯æœ€åä¸€æ¬¡å˜åŒ–ï¼Œè®¾ç½®æ ‡è®°
                        if (shouldStop) {
                            trainingConfig.shouldStopAfterNextChange = true;
                            log('å°†åœ¨æ’­æ”¾ç›®æ ‡é€Ÿåº¦', newBpm, 'BPM ååœæ­¢è®­ç»ƒ');
                        }
                    }
                    
                    // é‡ç½®å°èŠ‚è®¡æ•°
                    trainingConfig.barsCompleted = 0;
                }
                
                // æ£€æŸ¥æ˜¯å¦åº”è¯¥åœ¨å½“å‰å°èŠ‚ç»“æŸååœæ­¢ï¼ˆå·²ç»æ’­æ”¾äº†ç›®æ ‡é€Ÿåº¦ï¼‰
                if (trainingConfig.shouldStopAfterNextChange && 
                    trainingConfig.currentBpm === trainingConfig.targetBpm) {
                    isTrainingMode = false;
                    if (trainingStatusText) {
                        trainingStatusText.textContent = 'å·²è¾¾åˆ°ç›®æ ‡é€Ÿåº¦';
                        trainingStatusText.style.color = '#27ae60';
                    }
                    if (toggleTrainingBtn) {
                        toggleTrainingBtn.textContent = 'å¼€å§‹è®­ç»ƒ';
                        toggleTrainingBtn.classList.add('start');
                        toggleTrainingBtn.classList.remove('stop');
                    }
                    trainingConfig.shouldStopAfterNextChange = false;
                    log('è®­ç»ƒå®Œæˆ: å·²è¾¾åˆ°å¹¶æ’­æ”¾ç›®æ ‡é€Ÿåº¦', trainingConfig.currentBpm, 'BPM');
                }
            } else if (trainingModeType === 'segmented') {
                // åˆ†æ®µè®­ç»ƒçš„é€»è¾‘
                handleSegmentBarComplete();
            }
        }
        
        // ä¸ºè®­ç»ƒæŒ‰é’®è®¾ç½®é”®ç›˜å¿«æ·é”®
        if (trainingBtn) {
            trainingBtn.setAttribute('aria-keyshortcuts', 'L');
            trainingBtn.setAttribute('title', 'è®­ç»ƒæ¨¡å¼ (Lé”®)');
        }
        
        // ä¸ºè®­ç»ƒæ¨¡å¼åˆ‡æ¢è®¾ç½®é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', (e) => {
            // é¿å…åœ¨è¾“å…¥æ¡†ä¸­è§¦å‘å¿«æ·é”®
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            
            // Eé”®åˆ‡æ¢è®­ç»ƒæ¨¡å¼
            if (e.key.toLowerCase() === 'e') {
                // é˜»æ­¢é»˜è®¤è¡Œä¸º
                e.preventDefault();
                
                // å¿½ç•¥é•¿æŒ‰é‡å¤è§¦å‘
                if (e.repeat) {
                    console.log('ğŸ”„ [training-shortcut] å¿½ç•¥é‡å¤äº‹ä»¶');
                    return;
                }
                
                // ğŸ”¥ ä½¿ç”¨æœ¬åœ°äº‹ä»¶é”é˜²æ­¢é‡å¤è§¦å‘
                if (!tryLocalLock()) {
                    return;
                }
                
                console.log('âœ… [training-shortcut] æ‰§è¡Œè®­ç»ƒæ¨¡å¼åˆ‡æ¢');
                // è§¦å‘è®­ç»ƒæ¨¡å¼åˆ‡æ¢
                if (toggleTrainingBtn && toggleTrainingBtn instanceof HTMLElement) {
                    toggleTrainingBtn.click();
                }
            }
        });
        
        // æ·»åŠ Lé”®å¿«æ·é”®
        document.addEventListener('keydown', (e) => {
            // ç¡®ä¿ä¸åœ¨è¾“å…¥æ¡†ä¸­æ—¶å“åº”å¿«æ·é”®
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                return;
            }
            
            if (e.key.toUpperCase() === 'L' && !e.ctrlKey && !e.altKey && !e.metaKey) {
                e.preventDefault();
                if (trainingModal) {
                    trainingModal.style.display = trainingModal.style.display === 'block' ? 'none' : 'block';
                }
            }
        });
        
        // ä¿®æ”¹schedulerå‡½æ•°ï¼Œåœ¨æ¯å°èŠ‚ç»“æŸæ—¶è°ƒç”¨onBarComplete
        // é¦–å…ˆï¼Œéœ€è¦æ‰¾åˆ°å¹¶ä¿®æ”¹åŸæ¥çš„schedulerå‡½æ•°
        // è¿™é‡Œæˆ‘ä»¬éœ€è¦ç¡®ä¿åœ¨æ¯å°èŠ‚çš„æœ€åä¸€æ‹å®Œæˆåè°ƒç”¨onBarComplete
        // ç”±äºæˆ‘ä»¬æ— æ³•ç›´æ¥ä¿®æ”¹ç°æœ‰å‡½æ•°ï¼Œæˆ‘ä»¬å°†é€šè¿‡æ‰©å±•ç°æœ‰åŠŸèƒ½æ¥å®ç°
        
        /* æ·»åŠ åˆ†æ®µè®­ç»ƒç›¸å…³çš„CSSæ ·å¼ */
        const trainingStyle = document.createElement('style');
        trainingStyle.textContent = `
            .training-mode-tabs {
                display: flex;
                flex-direction: column;
                gap: 15px;
            }
            
            .tab-buttons {
                display: flex;
                gap: 10px;
                margin-bottom: 15px;
            }
            
            .tab-btn {
                padding: 8px 16px;
                background-color: #f0f0f0;
                border: 1px solid #ddd;
                border-radius: 4px;
                cursor: pointer;
                transition: all 0.2s;
            }
            
            .tab-btn.active {
                background-color: #3498db;
                color: white;
                border-color: #3498db;
            }
            
            .tab-content {
                display: none;
                animation: fadeIn 0.3s ease-in-out;
            }
            
            .tab-content.active {
                display: block;
            }
            
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(-10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            
            .segments-container {
                max-height: 300px;
                overflow-y: auto;
                border: 1px solid #eee;
                border-radius: 4px;
                padding: 10px;
                margin: 10px 0;
            }
            
            .segment-config {
                border: 1px solid #ddd;
                border-radius: 4px;
                padding: 12px;
                margin-bottom: 10px;
                background-color: #f9f9f9;
                position: relative;
            }
            
            .segment-config h4 {
                margin-top: 0;
                margin-bottom: 10px;
                color: #2c3e50;
                font-size: 14px;
                font-weight: bold;
            }
            
            .segment-config .training-control-group {
                display: flex;
                align-items: center;
                margin-bottom: 8px;
                gap: 10px;
            }
            
            .segment-config .training-control-group:last-child {
                margin-bottom: 0;
            }
            
            .segment-config .training-control-group label {
                flex: 0 0 80px;
                font-size: 13px;
                color: #555;
            }
            
            .segment-config .training-control-group input {
                flex: 1;
                padding: 4px 8px;
                border: 1px solid #ddd;
                border-radius: 3px;
                font-size: 14px;
            }
            
            /* ç¾åŒ–æ»šåŠ¨æ¡ */
            .segments-container::-webkit-scrollbar {
                width: 6px;
            }
            
            .segments-container::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 3px;
            }
            
            .segments-container::-webkit-scrollbar-thumb {
                background: #ccc;
                border-radius: 3px;
            }
            
            .segments-container::-webkit-scrollbar-thumb:hover {
                background: #999;
            }
            
            /* å°å±å¹•è®¾å¤‡ (< 480px) - ç§»åŠ¨ä¼˜å…ˆåŸºç¡€æ ·å¼ */
        @media (max-width: 480px) {
            body {
                padding: 10px 0;
            }
            
            .container {
                width: 95%;
                padding: 20px;
            }
            
            h1 {
                font-size: clamp(20px, 6vw, 28px);
            }
            
            p {
                font-size: clamp(14px, 4vw, 16px);
            }
            
            /* æŒ‰é’®è°ƒæ•´ */
            button {
                min-width: 90px;
                min-height: 90px;
                margin-bottom: 10px;
            }
            
            .bpm-buttons-container {
                gap: 60px;
            }
            
            /* è®­ç»ƒæ§åˆ¶å¸ƒå±€ */
            .training-controls-wrapper {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            
            .countdown-control {
                justify-content: center;
            }
            
            /* å¢å¤§æ»‘å—æ§ä»¶ */
            input[type="range"] {
                height: 8px;
            }
            
            input[type="range"]::-webkit-slider-thumb {
                width: 24px;
                height: 24px;
            }
            
            input[type="range"]::-moz-range-thumb {
                width: 24px;
                height: 24px;
            }
            
            /* èŠ‚æ‹æŒ‡ç¤ºå™¨è°ƒæ•´ */
            .indicator-dots {
                gap: 8px;
            }
        }
        
        /* ä¸­ç­‰å±å¹•è®¾å¤‡ (481px - 768px) */
        @media (min-width: 481px) {
            .container {
                max-width: 600px;
                padding: 30px;
            }
            
            #bpm-value {
                font-size: 80px;
            }
            
            .controls {
                display: block;
            }
            
            .main-controls {
                display: flex;
                flex-direction: column;
                align-items: center;
            }
        }
        
        /* å¤§å±å¹•è®¾å¤‡ (769px - 1024px) */
        @media (min-width: 769px) {
            .container {
                max-width: 800px;
                padding: 40px;
            }
            
            #bpm-value {
                font-size: 96px;
            }
            
            .main-controls {
                display: flex;
                flex-direction: row;
                justify-content: center;
                gap: 30px;
                align-items: flex-start;
                flex-wrap: wrap;
            }
            
            .control-column {
                flex: 1;
                min-width: 250px;
            }
        }
        
        /* è¶…å¤§å±å¹•è®¾å¤‡ (> 1024px) */
        @media (min-width: 1025px) {
            .container {
                max-width: 900px;
            }
        }
        
        /* æ¨¡æ€çª—å£å“åº”å¼è°ƒæ•´ */
        @media (max-width: 600px) {
            .modal-content {
                width: 90%;
                margin: 15% auto;
                padding: 15px;
            }
            
            /* è®­ç»ƒæ ‡ç­¾é¡µå“åº”å¼ */
            .tab-buttons {
                flex-direction: column;
            }
            
            .tab-btn {
                text-align: center;
            }
            
            .segment-config .training-control-group {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .segment-config .training-control-group label {
                flex: none;
            }
            
            .segment-config .training-control-group input {
                width: 100%;
            }
        }
        `;
        document.head.appendChild(trainingStyle);
    </script>
    
    <!-- åŠ è½½æ¨¡å—åŒ–åº”ç”¨å…¥å£ -->
    <script type="module" src="main.js"></script>
</body>
</html>
